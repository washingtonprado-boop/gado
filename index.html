<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Controle de Animais</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <style>
        * {margin: 0; padding: 0; box-sizing: border-box;}
        body {font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; color: #1e293b;}
        .app-container {background: #f8fafc; min-height: 100vh;}
        .header {background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 2rem; box-shadow: 0 4px 20px rgba(0,0,0,0.15); position: relative; overflow: hidden;}
        .header::before {content: ''; position: absolute; top: -50%; right: -10%; width: 400px; height: 400px; background: rgba(255,255,255,0.1); border-radius: 50%;}
        .header h1 {font-size: 2rem; position: relative; z-index: 1; display: flex; align-items: center; gap: 1rem;}
        .header p {font-size: 1rem; opacity: 0.9; margin-top: 0.5rem; position: relative; z-index: 1;}
        .sync-status {position: absolute; top: 2rem; right: 2rem; background: rgba(255,255,255,0.2); padding: 0.5rem 1rem; border-radius: 2rem; font-size: 0.875rem; display: flex; align-items: center; gap: 0.5rem; backdrop-filter: blur(10px); cursor: pointer;}
        .sync-status:hover {background: rgba(255,255,255,0.3);}
        .sync-indicator {width: 8px; height: 8px; border-radius: 50%; background: #22c55e; animation: pulse 2s infinite;}
        @keyframes pulse {0%, 100% {opacity: 1;} 50% {opacity: 0.5;}}
        .nav-tabs {background: white; border-bottom: 2px solid #e2e8f0; padding: 0 2rem; display: flex; gap: 1rem; overflow-x: auto; box-shadow: 0 2px 8px rgba(0,0,0,0.05);}
        .nav-tab {padding: 1rem 1.5rem; border: none; background: none; cursor: pointer; font-size: 0.95rem; font-weight: 600; color: #64748b; border-bottom: 3px solid transparent; transition: all 0.3s; white-space: nowrap;}
        .nav-tab:hover {color: #667eea; background: #f8fafc;}
        .nav-tab.active {color: #667eea; border-bottom-color: #667eea;}
        .container {max-width: 1600px; margin: 0 auto; padding: 2rem;}
        .main-grid {display: grid; grid-template-columns: 420px 1fr; gap: 2rem;}
        .card {background: white; border-radius: 1rem; box-shadow: 0 4px 20px rgba(0,0,0,0.08); padding: 2rem; transition: transform 0.3s, box-shadow 0.3s;}
        .card:hover {transform: translateY(-2px); box-shadow: 0 8px 30px rgba(0,0,0,0.12);}
        .card h2 {font-size: 1.25rem; margin-bottom: 1.5rem; color: #1e293b; display: flex; align-items: center; gap: 0.75rem; padding-bottom: 1rem; border-bottom: 2px solid #f1f5f9;}
        .form-group {margin-bottom: 1.25rem;}
        .form-group label {display: block; font-size: 0.875rem; font-weight: 600; color: #475569; margin-bottom: 0.5rem;}
        .form-group input, .form-group select, .form-group textarea {width: 100%; padding: 0.75rem 1rem; border: 2px solid #e2e8f0; border-radius: 0.5rem; font-size: 0.875rem; transition: all 0.2s; background: #f8fafc;}
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {outline: none; border-color: #667eea; box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1); background: white;}
        .input-group {display: flex; gap: 0.5rem;}
        .input-group input {flex: 1;}
        .btn {padding: 0.75rem 1.5rem; border: none; border-radius: 0.5rem; font-size: 0.875rem; font-weight: 600; cursor: pointer; transition: all 0.3s; display: inline-flex; align-items: center; gap: 0.5rem; justify-content: center;}
        .btn-primary {background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;}
        .btn-primary:hover {transform: translateY(-2px); box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);}
        .btn-secondary {background: #e2e8f0; color: #334155;}
        .btn-secondary:hover {background: #cbd5e1;}
        .btn-danger {background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white;}
        .btn-success {background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); color: white;}
        .btn-warning {background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white;}
        .btn-group {display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.75rem; margin-top: 2rem;}
        .grid-2 {display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;}
        .checkbox-group {display: flex; flex-wrap: wrap; gap: 1.5rem; margin: 1rem 0; padding: 1rem; background: #f8fafc; border-radius: 0.5rem;}
        .checkbox-label {display: flex; align-items: center; gap: 0.5rem; font-size: 0.875rem; font-weight: 500; cursor: pointer; user-select: none;}
        .checkbox-label input[type="checkbox"] {width: 18px; height: 18px; cursor: pointer;}
        .search-box {padding: 1.5rem; border-bottom: 2px solid #f1f5f9;}
        .search-input {width: 100%; padding: 0.875rem 1.25rem; border: 2px solid #e2e8f0; border-radius: 0.75rem; font-size: 0.875rem; background: #f8fafc;}
        .search-input:focus {outline: none; border-color: #667eea; background: white;}
        .table-actions {padding: 1.5rem; display: flex; gap: 0.75rem; border-bottom: 2px solid #f1f5f9; flex-wrap: wrap;}
        .table-container {overflow-x: auto;}
        table {width: 100%; border-collapse: collapse;}
        thead {background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);}
        th {padding: 1rem 1.25rem; text-align: left; font-size: 0.75rem; font-weight: 700; color: #475569; text-transform: uppercase; letter-spacing: 0.5px;}
        td {padding: 1rem 1.25rem; font-size: 0.875rem; border-bottom: 1px solid #f1f5f9;}
        tbody tr {cursor: pointer; transition: all 0.2s;}
        tbody tr:hover {background: #f8fafc; transform: scale(1.01);}
        tbody tr.selected {background: #ede9fe;}
        .empty-state {padding: 4rem 2rem; text-align: center; color: #94a3b8;}
        .empty-state-icon {font-size: 4rem; margin-bottom: 1rem; opacity: 0.5;}
        .stats-grid {display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;}
        .stat-card {background: white; border-radius: 1rem; padding: 2rem; box-shadow: 0 4px 20px rgba(0,0,0,0.08); text-align: center; border-top: 4px solid; transition: transform 0.3s;}
        .stat-card:hover {transform: translateY(-4px);}
        .stat-card.blue {border-top-color: #3b82f6;} .stat-card.green {border-top-color: #22c55e;} .stat-card.red {border-top-color: #ef4444;} .stat-card.purple {border-top-color: #a855f7;} .stat-card.yellow {border-top-color: #f59e0b;} .stat-card.pink {border-top-color: #ec4899;}
        .stat-value {font-size: 2.5rem; font-weight: bold; margin-bottom: 0.5rem;}
        .stat-label {font-size: 0.875rem; color: #64748b; font-weight: 600;}
        .stat-value.blue {color: #3b82f6;} .stat-value.green {color: #22c55e;} .stat-value.red {color: #ef4444;} .stat-value.purple {color: #a855f7;} .stat-value.yellow {color: #f59e0b;} .stat-value.pink {color: #ec4899;}
        .chart-container {background: white; border-radius: 1rem; padding: 2rem; box-shadow: 0 4px 20px rgba(0,0,0,0.08); margin-bottom: 2rem;}
        .chart-grid {display: grid; grid-template-columns: repeat(auto-fit, minmax(450px, 1fr)); gap: 2rem;}
        .item-list {margin-top: 1.5rem;}
        .item-box {padding: 1rem; background: #f8fafc; margin-top: 0.75rem; border-radius: 0.75rem; display: flex; justify-content: space-between; align-items: center; border: 2px solid #e2e8f0; transition: all 0.2s;}
        .item-box:hover {border-color: #667eea; background: white;}
        .genealogy-tree {padding: 2rem; background: #f8fafc; border-radius: 1rem; margin-top: 1.5rem; border: 2px solid #e2e8f0;}
        .tree-node {background: white; padding: 1rem; border-radius: 0.75rem; margin: 0.5rem 0; border: 2px solid #e2e8f0; box-shadow: 0 2px 8px rgba(0,0,0,0.05);}
        .tree-node strong {color: #667eea;}
        .tree-branch {margin-left: 2rem; border-left: 2px solid #cbd5e1; padding-left: 1rem;}
        .modal {display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px);}
        .modal.active {display: flex; align-items: center; justify-content: center;}
        .modal-content {background: white; padding: 2rem; border-radius: 1rem; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3);}
        .hidden {display: none;}
        @media (max-width: 1024px) {.main-grid, .chart-grid {grid-template-columns: 1fr;} .header h1 {font-size: 1.5rem;} .sync-status {position: relative; top: auto; right: auto; margin-top: 1rem;}}
        @media (max-width: 640px) {.container, .card {padding: 1rem;} .btn-group, .stats-grid {grid-template-columns: 1fr;}}
    </style>
</head>
<body>
    <div class="app-container">
        <div class="header">
            <h1>üêÑ Sistema de Controle de Animais</h1>
            <p>Gest√£o completa e profissional do seu rebanho</p>
            <div class="sync-status" onclick="abrirModalFirebase()">
                <div class="sync-indicator"></div>
                <span id="syncStatus">Configurar Firebase</span>
            </div>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('animals')">üêÆ Animais</button>
            <button class="nav-tab" onclick="showTab('reports')">üìä Relat√≥rios</button>
            <button class="nav-tab" onclick="showTab('genealogy')">üå≥ Genealogia</button>
            <button class="nav-tab" onclick="showTab('racas')">üè∑Ô∏è Ra√ßas</button>
            <button class="nav-tab" onclick="showTab('locais')">üìç Locais</button>
            <button class="nav-tab" onclick="showTab('tools')">üßÆ Ferramentas</button>
            <button class="nav-tab" onclick="showTab('owners')">üë• Propriet√°rios</button>
        </div>

        <div class="container">
            <!-- Aba Animais -->
            <div id="tab-animals" class="tab-content">
                <div class="main-grid">
                    <div class="card">
                        <h2>üìù Dados do Animal</h2>
                        <form id="animalForm" onsubmit="return salvarAnimal(event)">
                            <div class="form-group">
                                <label>N√öMERO *</label>
                                <div class="input-group">
                                    <input type="text" id="numero" required>
                                    <button type="button" class="btn btn-primary" onclick="gerarNumero()">Gerar</button>
                                </div>
                            </div>

                            <div class="checkbox-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="usaBrinco" onchange="toggleBrinco()">
                                    Usar Brinco
                                </label>
                            </div>

                            <div class="form-group hidden" id="campoBrinco">
                                <label>Brinco</label>
                                <input type="text" id="brinco">
                            </div>

                            <div class="form-group">
                                <label>Nome</label>
                                <input type="text" id="nome">
                            </div>

                            <div class="grid-2">
                                <div class="form-group">
                                    <label>Sexo</label>
                                    <select id="sexo">
                                        <option value="M">Macho</option>
                                        <option value="F">F√™mea</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label>Ra√ßa</label>
                                    <select id="raca"></select>
                                </div>
                            </div>

                            <div class="form-group">
                                <label>Local/Pasto</label>
                                <select id="local"></select>
                            </div>

                            <div class="form-group">
                                <label>Propriet√°rio</label>
                                <select id="proprietario">
                                    <option value="">Selecione...</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label>Data de Nascimento</label>
                                <input type="date" id="dataNascimento">
                            </div>

                            <div class="grid-2">
                                <div class="form-group">
                                    <label>Pai</label>
                                    <select id="pai">
                                        <option value="">Selecione...</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label>M√£e</label>
                                    <select id="mae">
                                        <option value="">Selecione...</option>
                                    </select>
                                </div>
                            </div>

                            <div class="checkbox-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="semFerro">
                                    Sem Ferro
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" id="amamentando">
                                    Amamentando
                                </label>
                            </div>

                            <div class="form-group">
                                <label>Observa√ß√µes</label>
                                <textarea id="observacoes" rows="3"></textarea>
                            </div>

                            <div class="btn-group">
                                <button type="button" class="btn btn-secondary" onclick="limparForm()">üÜï Novo</button>
                                <button type="submit" class="btn btn-primary">üíæ Salvar</button>
                                <button type="button" class="btn btn-danger" onclick="excluirAnimal()">üóëÔ∏è Excluir</button>
                            </div>
                        </form>
                    </div>

                    <div class="card">
                        <div class="search-box">
                            <input type="text" class="search-input" placeholder="üîç Pesquisar..." onkeyup="pesquisarAnimais(this.value)">
                        </div>

                        <div class="table-actions">
                            <button class="btn btn-success" onclick="exportarExcel()">üì• Excel</button>
                            <button class="btn btn-danger" onclick="exportarPDF()">üìÑ PDF</button>
                            <button class="btn btn-warning" onclick="sincronizar()">üîÑ Sincronizar</button>
                        </div>

                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>N√öMERO</th>
                                        <th>Brinco</th>
                                        <th>Nome</th>
                                        <th>Sexo</th>
                                        <th>Ra√ßa</th>
                                        <th>Local</th>
                                    </tr>
                                </thead>
                                <tbody id="tabelaAnimais">
                                    <tr>
                                        <td colspan="6" class="empty-state">
                                            <div class="empty-state-icon">üêÆ</div>
                                            Nenhum animal cadastrado
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Outras abas (c√≥digo reduzido para economizar espa√ßo) -->
            <div id="tab-reports" class="tab-content hidden">
                <h2 style="margin-bottom: 2rem;">üìä Dashboard</h2>
                <div class="stats-grid">
                    <div class="stat-card blue"><div class="stat-value blue" id="totalAnimais">0</div><div class="stat-label">Total</div></div>
                    <div class="stat-card green"><div class="stat-value green" id="totalFemeas">0</div><div class="stat-label">F√™meas</div></div>
                    <div class="stat-card purple"><div class="stat-value purple" id="totalMachos">0</div><div class="stat-label">Machos</div></div>
                    <div class="stat-card yellow"><div class="stat-value yellow" id="totalAmamentando">0</div><div class="stat-label">Amamentando</div></div>
                    <div class="stat-card red"><div class="stat-value red" id="totalSemFerro">0</div><div class="stat-label">Sem Ferro</div></div>
                    <div class="stat-card pink"><div class="stat-value pink" id="totalRacas">0</div><div class="stat-label">Ra√ßas</div></div>
                </div>
                <div class="chart-grid">
                    <div class="chart-container"><h2>Ra√ßas</h2><canvas id="racaChart"></canvas></div>
                    <div class="chart-container"><h2>Sexo</h2><canvas id="sexoChart"></canvas></div>
                    <div class="chart-container"><h2>Locais</h2><canvas id="localChart"></canvas></div>
                    <div class="chart-container"><h2>Propriet√°rios</h2><canvas id="proprietarioChart"></canvas></div>
                </div>
                <div class="chart-container"><h2>Idade</h2><canvas id="idadeChart"></canvas></div>
            </div>

            <div id="tab-genealogy" class="tab-content hidden">
                <div class="card">
                    <h2>üå≥ √Årvore Geneal√≥gica</h2>
                    <div class="form-group">
                        <label>Selecione um Animal</label>
                        <select id="animalGenealogia" onchange="mostrarGenealogia()">
                            <option value="">Escolha...</option>
                        </select>
                    </div>
                    <div id="arvoreGenealogia"></div>
                </div>
            </div>

            <div id="tab-racas" class="tab-content hidden">
                <div class="card" style="max-width: 700px; margin: 0 auto;">
                    <h2>üè∑Ô∏è Ra√ßas</h2>
                    <div class="form-group"><input type="text" id="nomeRaca" placeholder="Nome da ra√ßa"></div>
                    <button class="btn btn-primary" onclick="adicionarRaca()">‚ûï Adicionar</button>
                    <div id="listaRacas" class="item-list"></div>
                </div>
            </div>

            <div id="tab-locais" class="tab-content hidden">
                <div class="card" style="max-width: 700px; margin: 0 auto;">
                    <h2>üìç Locais</h2>
                    <div class="form-group"><input type="text" id="nomeLocal" placeholder="Nome do local"></div>
                    <button class="btn btn-primary" onclick="adicionarLocal()">‚ûï Adicionar</button>
                    <div id="listaLocais" class="item-list"></div>
                </div>
            </div>

            <div id="tab-tools" class="tab-content hidden">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 2rem;">
                    <div class="card">
                        <h2>‚öñÔ∏è Arrobas</h2>
                        <div class="form-group"><label>Peso Vivo (KG)</label><input type="number" id="pesoVivo" step="0.01"></div>
                        <div class="form-group"><label>Peso Morto (KG)</label><input type="number" id="pesoMorto" step="0.01"></div>
                        <button class="btn btn-primary" onclick="calcularArrobas()">Calcular</button>
                        <p id="resultadoArrobas" style="margin-top: 1.5rem; font-weight: bold; color: #667eea;"></p>
                    </div>
                    <div class="card">
                        <h2>ü§∞ Parto</h2>
                        <div class="form-group"><label>Data Insemina√ß√£o</label><input type="date" id="dataInseminacao"></div>
                        <button class="btn btn-primary" onclick="calcularParto()">Calcular</button>
                        <p id="resultadoParto" style="margin-top: 1.5rem; font-weight: bold; color: #667eea;"></p>
                    </div>
                    <div class="card">
                        <h2>üìÖ Idade</h2>
                        <div class="form-group"><label>Data Nascimento</label><input type="date" id="dataNascIdade"></div>
                        <button class="btn btn-primary" onclick="calcularIdade()">Calcular</button>
                        <p id="resultadoIdade" style="margin-top: 1.5rem; font-weight: bold; color: #667eea;"></p>
                    </div>
                </div>
            </div>

            <div id="tab-owners" class="tab-content hidden">
                <div class="card" style="max-width: 700px; margin: 0 auto;">
                    <h2>üë• Propriet√°rios</h2>
                    <div class="form-group"><input type="text" id="nomeProprietario" placeholder="Nome do propriet√°rio"></div>
                    <button class="btn btn-primary" onclick="adicionarProprietario()">‚ûï Adicionar</button>
                    <div id="listaProprietarios" class="item-list"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Firebase -->
    <div id="firebaseModal" class="modal">
        <div class="modal-content">
            <h2>üî• Firebase</h2>
            <div class="form-group"><label>API Key</label><input type="text" id="firebaseApiKey"></div>
            <div class="form-group"><label>Auth Domain</label><input type="text" id="firebaseAuthDomain"></div>
            <div class="form-group"><label>Database URL</label><input type="text" id="firebaseDatabaseURL"></div>
            <div class="form-group"><label>Project ID</label><input type="text" id="firebaseProjectId"></div>
            <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                <button class="btn btn-secondary" onclick="fecharModalFirebase()">Cancelar</button>
                <button class="btn btn-primary" onclick="salvarConfigFirebase()">üíæ Salvar</button>
            </div>
        </div>
    </div>

    <script>
        let animais = [], proprietarios = [], racas = ['NELORE','ANGUS','BRAHMAN','TABAPU√É','SENEPOL','GIROLANDO','HOLANDESA','GIR','JERSEY'], locais = ['PASTO 1','PASTO 2','CURRAL'], animalAtualId = null, charts = {}, database = null, firebaseConfig = null;

        async function init() {await carregarDados(); await tentarConectarFirebase(); atualizarSelects();}

        async function carregarDados() {
            try {
                const [a, p, r, l] = await Promise.all([window.storage.get('animais').catch(()=>null), window.storage.get('proprietarios').catch(()=>null), window.storage.get('racas').catch(()=>null), window.storage.get('locais').catch(()=>null)]);
                animais = a ? JSON.parse(a.value) : [];
                proprietarios = p ? JSON.parse(p.value) : [];
                racas = r ? JSON.parse(r.value) : racas;
                locais = l ? JSON.parse(l.value) : locais;
            } catch {
                animais = JSON.parse(localStorage.getItem('animais') || '[]');
                proprietarios = JSON.parse(localStorage.getItem('proprietarios') || '[]');
                racas = JSON.parse(localStorage.getItem('racas') || JSON.stringify(racas));
                locais = JSON.parse(localStorage.getItem('locais') || JSON.stringify(locais));
            }
            renderizarTabela(); atualizarListaProprietarios(); atualizarListaRacas(); atualizarListaLocais(); atualizarSelectGenealogia();
        }

        async function salvarDados() {
            try {
                await Promise.all([window.storage.set('animais', JSON.stringify(animais)), window.storage.set('proprietarios', JSON.stringify(proprietarios)), window.storage.set('racas', JSON.stringify(racas)), window.storage.set('locais', JSON.stringify(locais))]);
                localStorage.setItem('animais', JSON.stringify(animais));
                localStorage.setItem('proprietarios', JSON.stringify(proprietarios));
                localStorage.setItem('racas', JSON.stringify(racas));
                localStorage.setItem('locais', JSON.stringify(locais));
                atualizarStatusSync('Salvo ‚úì');
                if (!firebase.apps.length) firebase.initializeApp(config);
                database = firebase.database();
                atualizarStatusSync('Firebase OK ‚úì');
                database.ref('animais').on('value', s => {if (s.exists()) {animais = s.val() || []; renderizarTabela();}});
            } catch (e) {atualizarStatusSync('Erro Firebase');}
        }

        async function sincronizarComFirebase() {
            if (!database) return;
            try {
                await database.ref('animais').set(animais);
                await database.ref('proprietarios').set(proprietarios);
                await database.ref('racas').set(racas);
                await database.ref('locais').set(locais);
                atualizarStatusSync('Sincronizado ‚úì');
            } catch {atualizarStatusSync('Erro sync');}
        }

        function abrirModalFirebase() {document.getElementById('firebaseModal').classList.add('active');}
        function fecharModalFirebase() {document.getElementById('firebaseModal').classList.remove('active');}

        async function salvarConfigFirebase() {
            const config = {apiKey: document.getElementById('firebaseApiKey').value, authDomain: document.getElementById('firebaseAuthDomain').value, databaseURL: document.getElementById('firebaseDatabaseURL').value, projectId: document.getElementById('firebaseProjectId').value};
            if (!config.apiKey || !config.databaseURL) {alert('Preencha API Key e Database URL'); return;}
            try {
                await window.storage.set('firebaseConfig', JSON.stringify(config));
                await conectarFirebase(config);
                fecharModalFirebase();
                alert('‚úÖ Firebase OK!');
            } catch (e) {alert('‚ùå Erro: ' + e.message);}
        }

        async function sincronizar() {atualizarStatusSync('Sincronizando...'); await salvarDados(); if (database) await sincronizarComFirebase(); await carregarDados(); alert('‚úÖ Sync OK!');}
        function atualizarStatusSync(s) {document.getElementById('syncStatus').textContent = s;}
        function toggleBrinco() {const u = document.getElementById('usaBrinco').checked, c = document.getElementById('campoBrinco'); u ? c.classList.remove('hidden') : (c.classList.add('hidden'), document.getElementById('brinco').value = '');}

        function atualizarSelects() {
            document.getElementById('raca').innerHTML = racas.map(r => `<option value="${r}">${r}</option>`).join('');
            document.getElementById('local').innerHTML = '<option value="">Selecione...</option>' + locais.map(l => `<option value="${l}">${l}</option>`).join('');
            const machos = animais.filter(a => a.sexo === 'M'), femeas = animais.filter(a => a.sexo === 'F');
            document.getElementById('pai').innerHTML = '<option value="">Selecione...</option>' + machos.map(a => `<option value="${a.id}">${a.numero} - ${a.nome || 'Sem nome'}</option>`).join('');
            document.getElementById('mae').innerHTML = '<option value="">Selecione...</option>' + femeas.map(a => `<option value="${a.id}">${a.numero} - ${a.nome || 'Sem nome'}</option>`).join('');
        }

        async function salvarAnimal(e) {
            e.preventDefault();
            const d = {id: animalAtualId || Date.now().toString(), numero: document.getElementById('numero').value.toUpperCase(), brinco: document.getElementById('usaBrinco').checked ? document.getElementById('brinco').value.toUpperCase() : '', nome: document.getElementById('nome').value.toUpperCase(), sexo: document.getElementById('sexo').value, raca: document.getElementById('raca').value, local: document.getElementById('local').value, proprietario: document.getElementById('proprietario').value, dataNascimento: document.getElementById('dataNascimento').value, pai: document.getElementById('pai').value, mae: document.getElementById('mae').value, semFerro: document.getElementById('semFerro').checked, amamentando: document.getElementById('amamentando').checked, observacoes: document.getElementById('observacoes').value};
            animalAtualId ? (animais[animais.findIndex(a => a.id === animalAtualId)] = d) : animais.push(d);
            await salvarDados();
            renderizarTabela(); atualizarSelectGenealogia(); limparForm();
            alert('‚úÖ Salvo!');
            return false;
        }

        function renderizarTabela(lista = animais) {
            const t = document.getElementById('tabelaAnimais');
            if (lista.length === 0) {t.innerHTML = '<tr><td colspan="6" class="empty-state"><div class="empty-state-icon">üêÆ</div>Nenhum animal</td></tr>'; return;}
            t.innerHTML = lista.map(a => `<tr onclick="selecionarAnimal('${a.id}')" class="${animalAtualId === a.id ? 'selected' : ''}"><td><strong>${a.numero}</strong></td><td>${a.brinco || '-'}</td><td>${a.nome || '-'}</td><td>${a.sexo === 'M' ? '‚ôÇÔ∏è' : '‚ôÄÔ∏è'}</td><td>${a.raca}</td><td>${a.local || '-'}</td></tr>`).join('');
        }

        function selecionarAnimal(id) {
            const a = animais.find(x => x.id === id);
            if (!a) return;
            animalAtualId = id;
            document.getElementById('numero').value = a.numero;
            if (a.brinco) {document.getElementById('usaBrinco').checked = true; toggleBrinco(); document.getElementById('brinco').value = a.brinco;}
            document.getElementById('nome').value = a.nome || '';
            document.getElementById('sexo').value = a.sexo;
            document.getElementById('raca').value = a.raca;
            document.getElementById('local').value = a.local || '';
            document.getElementById('proprietario').value = a.proprietario || '';
            document.getElementById('dataNascimento').value = a.dataNascimento || '';
            document.getElementById('pai').value = a.pai || '';
            document.getElementById('mae').value = a.mae || '';
            document.getElementById('semFerro').checked = a.semFerro || false;
            document.getElementById('amamentando').checked = a.amamentando || false;
            document.getElementById('observacoes').value = a.observacoes || '';
            renderizarTabela();
        }

        function limparForm() {document.getElementById('animalForm').reset(); document.getElementById('usaBrinco').checked = false; toggleBrinco(); animalAtualId = null; atualizarSelects(); renderizarTabela();}

        async function excluirAnimal() {
            if (!animalAtualId) {alert('‚ö†Ô∏è Selecione um animal'); return;}
            if (confirm('üóëÔ∏è Excluir?')) {animais = animais.filter(a => a.id !== animalAtualId); await salvarDados(); renderizarTabela(); limparForm(); alert('‚úÖ Exclu√≠do!');}
        }

        function gerarNumero() {const m = animais.reduce((max, a) => {const n = parseInt(a.numero) || 0; return n > max ? n : max;}, 0); document.getElementById('numero').value = (m + 1).toString().padStart(4, '0');}
        function pesquisarAnimais(t) {const f = animais.filter(a => Object.values(a).some(v => String(v).toLowerCase().includes(t.toLowerCase()))); renderizarTabela(f);}

        function atualizarSelectGenealogia() {document.getElementById('animalGenealogia').innerHTML = '<option value="">Escolha...</option>' + animais.map(a => `<option value="${a.id}">${a.numero} - ${a.nome || 'Sem nome'}</option>`).join('');}

        function mostrarGenealogia() {
            const id = document.getElementById('animalGenealogia').value;
            if (!id) {document.getElementById('arvoreGenealogia').innerHTML = ''; return;}
            const a = animais.find(x => x.id === id);
            if (!a) return;
            document.getElementById('arvoreGenealogia').innerHTML = '<div class="genealogy-tree">' + gerarArvoreHTML(a, 0) + '</div>';
        }

        function gerarArvoreHTML(a, n) {
            if (!a) return '';
            let h = `<div class="tree-node" style="margin-left:${n*20}px"><strong>üêÆ ${a.numero}</strong> - ${a.nome || 'Sem nome'}<br><small>Ra√ßa: ${a.raca} | Sexo: ${a.sexo === 'M' ? 'Macho' : 'F√™mea'}</small></div>`;
            if (a.pai || a.mae) {
                h += '<div class="tree-branch">';
                if (a.pai) {const p = animais.find(x => x.id === a.pai); if (p) h += '<div><strong>Pai:</strong></div>' + gerarArvoreHTML(p, n + 1);}
                if (a.mae) {const m = animais.find(x => x.id === a.mae); if (m) h += '<div><strong>M√£e:</strong></div>' + gerarArvoreHTML(m, n + 1);}
                h += '</div>';
            }
            return h;
        }

        function showTab(n) {document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden')); document.querySelectorAll('.nav-tab').forEach(b => b.classList.remove('active')); document.getElementById(`tab-${n}`).classList.remove('hidden'); event.target.classList.add('active'); if (n === 'reports') setTimeout(atualizarEstatisticas, 100);}

        async function adicionarRaca() {const n = document.getElementById('nomeRaca').value.trim().toUpperCase(); if (n && !racas.includes(n)) {racas.push(n); racas.sort(); await salvarDados(); atualizarListaRacas(); atualizarSelects(); document.getElementById('nomeRaca').value = ''; alert('‚úÖ Adicionado!');} else if (racas.includes(n)) alert('‚ö†Ô∏è J√° existe!'); else alert('‚ö†Ô∏è Digite um nome!');}
        function atualizarListaRacas() {document.getElementById('listaRacas').innerHTML = racas.map(r => `<div class="item-box"><span><strong>üè∑Ô∏è ${r}</strong></span><button class="btn btn-danger" style="padding:0.5rem 1rem" onclick="removerRaca('${r}')">üóëÔ∏è</button></div>`).join('');}
        async function removerRaca(n) {if (confirm(`üóëÔ∏è Remover ${n}?`)) {racas = racas.filter(r => r !== n); await salvarDados(); atualizarListaRacas(); atualizarSelects(); alert('‚úÖ Removido!');}}

        async function adicionarLocal() {const n = document.getElementById('nomeLocal').value.trim().toUpperCase(); if (n && !locais.includes(n)) {locais.push(n); locais.sort(); await salvarDados(); atualizarListaLocais(); atualizarSelects(); document.getElementById('nomeLocal').value = ''; alert('‚úÖ Adicionado!');} else if (locais.includes(n)) alert('‚ö†Ô∏è J√° existe!'); else alert('‚ö†Ô∏è Digite um nome!');}
        function atualizarListaLocais() {document.getElementById('listaLocais').innerHTML = locais.map(l => `<div class="item-box"><span><strong>üìç ${l}</strong></span><button class="btn btn-danger" style="padding:0.5rem 1rem" onclick="removerLocal('${l}')">üóëÔ∏è</button></div>`).join('');}
        async function removerLocal(n) {if (confirm(`üóëÔ∏è Remover ${n}?`)) {locais = locais.filter(l => l !== n); await salvarDados(); atualizarListaLocais(); atualizarSelects(); alert('‚úÖ Removido!');}}

        async function adicionarProprietario() {const n = document.getElementById('nomeProprietario').value.trim().toUpperCase(); if (n && !proprietarios.includes(n)) {proprietarios.push(n); proprietarios.sort(); await salvarDados(); atualizarListaProprietarios(); document.getElementById('nomeProprietario').value = ''; alert('‚úÖ Adicionado!');} else if (proprietarios.includes(n)) alert('‚ö†Ô∏è J√° existe!'); else alert('‚ö†Ô∏è Digite um nome!');}
        function atualizarListaProprietarios() {const s = document.getElementById('proprietario'); s.innerHTML = '<option value="">Selecione...</option>'; proprietarios.forEach(p => s.innerHTML += `<option value="${p}">${p}</option>`); document.getElementById('listaProprietarios').innerHTML = proprietarios.map(p => `<div class="item-box"><span><strong>üë§ ${p}</strong></span><button class="btn btn-danger" style="padding:0.5rem 1rem" onclick="removerProprietario('${p}')">üóëÔ∏è</button></div>`).join('');}
        async function removerProprietario(n) {if (confirm(`üóëÔ∏è Remover ${n}?`)) {proprietarios = proprietarios.filter(p => p !== n); await salvarDados(); atualizarListaProprietarios(); alert('‚úÖ Removido!');}}

        function atualizarEstatisticas() {
            document.getElementById('totalAnimais').textContent = animais.length;
            document.getElementById('totalFemeas').textContent = animais.filter(a => a.sexo === 'F').length;
            document.getElementById('totalMachos').textContent = animais.filter(a => a.sexo === 'M').length;
            document.getElementById('totalAmamentando').textContent = animais.filter(a => a.amamentando).length;
            document.getElementById('totalSemFerro').textContent = animais.filter(a => a.semFerro).length;
            document.getElementById('totalRacas').textContent = [...new Set(animais.map(a => a.raca))].length;
            criarGraficos();
        }

        function criarGraficos() {
            const d1 = {}; animais.forEach(a => d1[a.raca] = (d1[a.raca] || 0) + 1);
            if (charts.raca) charts.raca.destroy();
            charts.raca = new Chart(document.getElementById('racaChart'), {type: 'bar', data: {labels: Object.keys(d1), datasets: [{label: 'Qtd', data: Object.values(d1), backgroundColor: 'rgba(102,126,234,0.8)', borderRadius: 8}]}, options: {responsive: true, plugins: {legend: {display: false}}}});

            const m = animais.filter(a => a.sexo === 'M').length, f = animais.filter(a => a.sexo === 'F').length;
            if (charts.sexo) charts.sexo.destroy();
            charts.sexo = new Chart(document.getElementById('sexoChart'), {type: 'doughnut', data: {labels: ['‚ôÇÔ∏è Machos', '‚ôÄÔ∏è F√™meas'], datasets: [{data: [m, f], backgroundColor: ['rgba(168,85,247,0.8)', 'rgba(236,72,153,0.8)']}]}, options: {responsive: true}});

            const d2 = {}; animais.forEach(a => {if (a.local) d2[a.local] = (d2[a.local] || 0) + 1;});
            if (charts.local) charts.local.destroy();
            charts.local = new Chart(document.getElementById('localChart'), {type: 'bar', data: {labels: Object.keys(d2), datasets: [{label: 'Qtd', data: Object.values(d2), backgroundColor: 'rgba(34,197,94,0.8)', borderRadius: 8}]}, options: {responsive: true, indexAxis: 'y', plugins: {legend: {display: false}}}});

            const d3 = {}; animais.forEach(a => {if (a.proprietario) d3[a.proprietario] = (d3[a.proprietario] || 0) + 1;});
            if (charts.prop) charts.prop.destroy();
            charts.prop = new Chart(document.getElementById('proprietarioChart'), {type: 'bar', data: {labels: Object.keys(d3), datasets: [{label: 'Qtd', data: Object.values(d3), backgroundColor: 'rgba(245,158,11,0.8)', borderRadius: 8}]}, options: {responsive: true, indexAxis: 'y', plugins: {legend: {display: false}}}});

            const fx = {'0-6m': 0, '6-12m': 0, '1-2a': 0, '2-4a': 0, '4+a': 0}, hj = new Date();
            animais.forEach(a => {if (a.dataNascimento) {const ns = new Date(a.dataNascimento), ms = (hj - ns) / (1000*60*60*24*30); if (ms < 6) fx['0-6m']++; else if (ms < 12) fx['6-12m']++; else if (ms < 24) fx['1-2a']++; else if (ms < 48) fx['2-4a']++; else fx['4+a']++;}});
            if (charts.idade) charts.idade.destroy();
            charts.idade = new Chart(document.getElementById('idadeChart'), {type: 'line', data: {labels: Object.keys(fx), datasets: [{label: 'Qtd', data: Object.values(fx), borderColor: '#3b82f6', backgroundColor: 'rgba(59,130,246,0.1)', fill: true, tension: 0.4}]}, options: {responsive: true}});
        }

        function calcularArrobas() {const pv = parseFloat(document.getElementById('pesoVivo').value), pm = parseFloat(document.getElementById('pesoMorto').value); if (pv) document.getElementById('resultadoArrobas').textContent = `${((pv * 0.5) / 15).toFixed(2)} @`; else if (pm) document.getElementById('resultadoArrobas').textContent = `${(pm / 15).toFixed(2)} @`; else document.getElementById('resultadoArrobas').textContent = 'Digite um peso';}
        function calcularParto() {const d = document.getElementById('dataInseminacao').value; if (!d) {alert('Selecione data'); return;} const dt = new Date(d); dt.setDate(dt.getDate() + 280); const d1 = new Date(dt); dt.setDate(dt.getDate() + 10); document.getElementById('resultadoParto').textContent = `${d1.toLocaleDateString('pt-BR')} a ${dt.toLocaleDateString('pt-BR')}`;}
        function calcularIdade() {const d = document.getElementById('dataNascIdade').value; if (!d) {alert('Selecione data'); return;} const hj = new Date(), ns = new Date(d), di = Math.ceil((hj - ns) / (1000*60*60*24)), an = Math.floor(di / 365), ms = Math.floor((di % 365) / 30); document.getElementById('resultadoIdade').textContent = `${an} ano(s) e ${ms} m√™s(es) (${di} dias)`;}

        function exportarExcel() {const ws = XLSX.utils.json_to_sheet(animais), wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Animais"); XLSX.writeFile(wb, `animais_${new Date().toISOString().split('T')[0]}.xlsx`);}
        function exportarPDF() {const {jsPDF} = window.jspdf, doc = new jsPDF(); doc.setFontSize(16); doc.text('Relat√≥rio de Animais', 14, 15); let y = 25; animais.forEach(a => {if (y > 280) {doc.addPage(); y = 15;} doc.setFontSize(10); doc.text(`${a.numero} - ${a.nome} - ${a.raca} - ${a.sexo} - ${a.local || ''}`, 14, y); y += 7;}); doc.save(`animais_${new Date().toISOString().split('T')[0]}.pdf`);}

        init();
    </script>
</body>
</html> (database) await sincronizarComFirebase();
            } catch (e) {atualizarStatusSync('Erro');}
        }

        async function tentarConectarFirebase() {
            try {
                const cfg = await window.storage.get('firebaseConfig').catch(()=>null);
                if (cfg) {firebaseConfig = JSON.parse(cfg.value); await conectarFirebase(firebaseConfig);}
            } catch {}
        }

        async function conectarFirebase(config) {
            try {
                if
