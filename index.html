<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SisGado Pro - Sistema Premium</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, set, get, remove } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';
        
        const firebaseConfig = {
            apiKey: "AIzaSyC7SscZZ2uhic2JXaQYfmnvh5mRgwpk0y8",
            authDomain: "gado-5821a.firebaseapp.com",
            databaseURL: "https://gado-5821a-default-rtdb.firebaseio.com",
            projectId: "gado-5821a",
            storageBucket: "gado-5821a.firebasestorage.app",
            messagingSenderId: "1065455551718",
            appId: "1:1065455551718:web:9e20cc6e84dc76e0ae6727",
            measurementId: "G-Q98K1CMBK3"
        };
        
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        
        window.firebaseDB = { database, ref, set, get, remove };
    </script>
    
    <style>
        * {margin: 0; padding: 0; box-sizing: border-box;}
        body {font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh;}
        .app-container {background: #f8fafc; min-height: 100vh;}
        .header {background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); color: white; padding: 2.5rem; box-shadow: 0 10px 40px rgba(0,0,0,0.3); position: relative; border-bottom: 3px solid #3b82f6;}
        .header h1 {font-size: 2.5rem; font-weight: 800; margin-bottom: 0.5rem;}
        .sync-status {position: absolute; top: 2rem; right: 2rem; background: rgba(59, 130, 246, 0.2); padding: 0.7rem 1.5rem; border-radius: 2rem; font-size: 0.875rem; border: 1px solid rgba(59, 130, 246, 0.3); cursor: pointer;}
        .sync-status.online {background: rgba(34, 197, 94, 0.2); border-color: rgba(34, 197, 94, 0.3);}
        .nav-tabs {background: white; border-bottom: 2px solid #e2e8f0; padding: 0 2rem; display: flex; gap: 0.5rem; overflow-x: auto; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 10px rgba(0,0,0,0.05);}
        .nav-tab {padding: 1.2rem 1.5rem; border: none; background: none; cursor: pointer; font-size: 0.9rem; font-weight: 600; color: #64748b; border-bottom: 3px solid transparent; transition: all 0.3s; white-space: nowrap;}
        .nav-tab:hover {color: #3b82f6; transform: translateY(-2px);}
        .nav-tab.active {color: #3b82f6; border-bottom-color: #3b82f6; background: linear-gradient(180deg, transparent 0%, rgba(59, 130, 246, 0.05) 100%);}
        .container {max-width: 1600px; margin: 0 auto; padding: 2rem;}
        .main-grid {display: grid; grid-template-columns: 420px 1fr; gap: 2rem;}
        .card {background: white; border-radius: 1.2rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); padding: 2rem; margin-bottom: 2rem; border: 1px solid rgba(0,0,0,0.05); transition: all 0.3s;}
        .card:hover {box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);}
        .card h2, .card h3 {margin-bottom: 1.5rem; color: #1e293b; font-weight: 700;}
        .form-group {margin-bottom: 1.2rem;}
        .form-group label {display: block; font-size: 0.8rem; font-weight: 700; color: #475569; text-transform: uppercase; margin-bottom: 0.5rem; letter-spacing: 0.5px;}
        .form-group input, .form-group select, .form-group textarea {width: 100%; padding: 0.8rem 1rem; border: 2px solid #e2e8f0; border-radius: 0.7rem; font-size: 0.95rem; transition: all 0.3s; background: #f8fafc;}
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {outline: none; border-color: #3b82f6; background: white; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);}
        .btn {padding: 0.8rem 1.5rem; border: none; border-radius: 0.7rem; font-weight: 600; cursor: pointer; transition: all 0.3s; display: inline-flex; align-items: center; justify-content: center; gap: 0.6rem; font-size: 0.95rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1);}
        .btn:hover {transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.15);}
        .btn-primary {background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white;}
        .btn-success {background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); color: white;}
        .btn-danger {background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white;}
        .btn-warning {background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white;}
        .btn-secondary {background: linear-gradient(135deg, #64748b 0%, #475569 100%); color: white;}
        .btn-small {padding: 0.4rem 0.8rem; font-size: 0.85rem;}
        .grid-2 {display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;}
        .checkbox-group {display: flex; gap: 1.5rem; margin: 1rem 0; padding: 1.2rem; background: linear-gradient(135deg, #f8fafc 0%, #e0f2fe 100%); border-radius: 0.7rem; border: 2px dashed #cbd5e1;}
        .checkbox-group label {display: flex; align-items: center; gap: 0.5rem; cursor: pointer; font-weight: 500;}
        table {width: 100%; border-collapse: collapse;}
        th {background: linear-gradient(135deg, #f8fafc 0%, #e0f2fe 100%); padding: 1.2rem; text-align: left; font-size: 0.75rem; color: #475569; border-bottom: 2px solid #cbd5e1; font-weight: 700; text-transform: uppercase;}
        td {padding: 1.2rem; border-bottom: 1px solid #f1f5f9; font-size: 0.9rem;}
        tr:hover {background: linear-gradient(90deg, #f1f5f9 0%, #e0f2fe 100%); cursor: pointer;}
        .hidden {display: none;}
        .stats-grid {display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;}
        .stat-card {background: linear-gradient(135deg, white 0%, #f8fafc 100%); padding: 2rem; border-radius: 1.2rem; text-align: center; border-bottom: 4px solid #3b82f6; box-shadow: 0 4px 6px rgba(0,0,0,0.07); transition: all 0.3s;}
        .stat-card:hover {transform: translateY(-5px); box-shadow: 0 12px 24px rgba(0,0,0,0.12);}
        .badge {padding: 0.3rem 0.8rem; border-radius: 1rem; font-size: 0.75rem; font-weight: 600; display: inline-block;}
        .badge-blue {background: #dbeafe; color: #1e40af;}
        .badge-pink {background: #fce7f3; color: #be185d;}
        .item-box {display: flex; justify-content: space-between; align-items: center; padding: 1rem 1.2rem; background: linear-gradient(135deg, #f8fafc 0%, white 100%); border-radius: 0.7rem; margin-bottom: 0.7rem; border: 2px solid #e2e8f0; transition: all 0.3s;}
        .item-box:hover {border-color: #3b82f6; transform: translateX(5px);}
        .btn-group {display: flex; gap: 0.5rem;}
        .foto-preview {width: 120px; height: 120px; border-radius: 0.7rem; object-fit: cover; border: 3px solid #e2e8f0; margin-top: 0.5rem;}
        .foto-container {text-align: center; margin: 1rem 0;}
        @media print {.nav-tabs, .sync-status, .btn {display: none !important;}}
        @media (max-width: 768px) {.main-grid, .grid-2 {grid-template-columns: 1fr;}}
        
        /* Modal para visualizar foto */
        .modal {display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9);}
        .modal-content {margin: auto; display: block; max-width: 90%; max-height: 90%; margin-top: 2%;}
        .close-modal {position: absolute; top: 20px; right: 35px; color: #f1f1f1; font-size: 40px; font-weight: bold; cursor: pointer;}
        .close-modal:hover {color: #bbb;}
    </style>
</head>
<body>
    <div class="app-container">
        <div class="header">
            <h1>üêÑ SisGado Pro</h1>
            <p>Gest√£o Pecu√°ria Inteligente 2026</p>
            <div class="sync-status" id="syncStatus" onclick="sincronizarDados()">
                <span id="syncText">üîÑ Sincronizar</span>
            </div>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('animals')">üêÆ Rebanho</button>
            <button class="nav-tab" onclick="showTab('reprodutores')">üêÇ Reprodutores</button>
            <button class="nav-tab" onclick="showTab('reports')">üìä Dashboard</button>
            <button class="nav-tab" onclick="showTab('relatorios')">üìÑ Relat√≥rios</button>
            <button class="nav-tab" onclick="showTab('genealogy')">üå≥ Genealogia</button>
            <button class="nav-tab" onclick="showTab('racas')">üè∑Ô∏è Ra√ßas/Locais</button>
            <button class="nav-tab" onclick="showTab('owners')">üë• Propriet√°rios</button>
        </div>

        <div class="container">
            <!-- TAB REBANHO -->
            <div id="tab-animals" class="tab-content">
                <div class="main-grid">
                    <div class="card">
                        <h2>üìã Cadastro de Animal</h2>
                        <form id="animalForm" onsubmit="salvarAnimal(event)">
                            <div class="form-group">
                                <label>N√∫mero/ID</label>
                                <div style="display:flex; gap:8px">
                                    <input type="text" id="numero" required style="flex: 1;">
                                    <button type="button" class="btn btn-secondary" onclick="gerarNumero()" style="padding: 0.8rem 1rem;">üî¢</button>
                                </div>
                            </div>

                            <div class="form-group">
                                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; text-transform: none;">
                                    <input type="checkbox" id="temBrinco" onchange="toggleBrinco()" style="width: auto;">
                                    Possui Brinco
                                </label>
                                <input type="text" id="brinco" placeholder="N√∫mero do brinco" style="display: none; margin-top: 0.5rem;">
                            </div>
                            <div class="form-group">
                                <label>Nome</label>
                                <input type="text" id="nome">
                            </div>
                            
                            <!-- SE√á√ÉO DE FOTO -->
                            <div class="form-group">
                                <label>üì∏ Foto do Animal</label>
                                <input type="file" id="fotoAnimal" accept="image/*" onchange="previewFoto(event)" style="padding: 0.5rem;">
                                <div class="foto-container" id="fotoContainer" style="display: none;">
                                    <img id="fotoPreview" class="foto-preview" onclick="ampliarFoto()">
                                    <button type="button" class="btn btn-danger btn-small" onclick="removerFoto()" style="margin-top: 0.5rem; width: 100%;">üóëÔ∏è Remover Foto</button>
                                </div>
                            </div>
                            
                            <div class="grid-2">
                                <div class="form-group">
                                    <label>Sexo</label>
                                    <select id="sexo">
                                        <option value="F">F√™mea</option>
                                        <option value="M">Macho</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Ra√ßa</label>
                                    <select id="raca"></select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Local/Pasto</label>
                                <select id="local"></select>
                            </div>
                            <div class="form-group">
                                <label>Propriet√°rio</label>
                                <select id="proprietario"></select>
                            </div>
                            <div class="form-group">
                                <label>Nascimento</label>
                                <input type="date" id="dataNascimento">
                            </div>
                            <div class="grid-2">
                                <div class="form-group">
                                    <label>Pai</label>
                                    <select id="pai">
                                        <option value="">N√£o informado</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>M√£e</label>
                                    <select id="mae">
                                        <option value="">N√£o informada</option>
                                    </select>
                                </div>
                            </div>
                            <div class="checkbox-group">
                                <label><input type="checkbox" id="semFerro"> Sem Ferro</label>
                                <label><input type="checkbox" id="amamentando"> Amamentando</label>
                            </div>
                            <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                <button type="submit" class="btn btn-primary">üíæ Salvar</button>
                                <button type="button" class="btn btn-warning" onclick="limparForm()">üîÑ Novo</button>
                            </div>
                            <button type="button" class="btn btn-danger" onclick="excluirAnimal()" style="width: 100%; margin-top: 10px;">üóëÔ∏è Excluir</button>
                        </form>
                    </div>

                    <div class="card">
                        <div style="display:flex; justify-content: space-between; margin-bottom: 1.5rem; gap: 1rem; flex-wrap: wrap;">
                            <input type="text" id="campoPesquisa" placeholder="üîç Pesquisar..." style="flex: 1; min-width: 200px; padding: 0.8rem; border: 2px solid #e2e8f0; border-radius: 0.7rem;" onkeyup="pesquisarAnimais(this.value)">
                            <button class="btn btn-success" onclick="exportarExcel()">üìä Excel</button>
                        </div>
                        <div style="overflow-x: auto;">
                            <table>
                                <thead>
                                    <tr>
                                        <th>üì∏</th>
                                        <th>üî¢ ID</th>
                                        <th>üìù Nome</th>
                                        <th>‚ö• Sexo</th>
                                        <th>üêÑ Ra√ßa</th>
                                        <th>üìç Local</th>
                                        <th>üéÇ Idade</th>
                                    </tr>
                                </thead>
                                <tbody id="tabelaAnimais"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TAB REPRODUTORES -->
            <div id="tab-reprodutores" class="tab-content hidden">
                <div class="main-grid">
                    <div class="card">
                        <h2>üêÇ Cadastro de Reprodutor</h2>
                        <form id="reprodutorForm" onsubmit="salvarReprodutor(event)">
                            <div class="form-group">
                                <label>Registro/ID</label>
                                <input type="text" id="regReprodutor" required>
                            </div>
                            <div class="form-group">
                                <label>Nome do Reprodutor</label>
                                <input type="text" id="nomeReprodutor" required>
                            </div>
                            
                            <!-- FOTO REPRODUTOR -->
                            <div class="form-group">
                                <label>üì∏ Foto do Reprodutor</label>
                                <input type="file" id="fotoReprodutor" accept="image/*" onchange="previewFotoReprodutor(event)" style="padding: 0.5rem;">
                                <div class="foto-container" id="fotoContainerReprodutor" style="display: none;">
                                    <img id="fotoPreviewReprodutor" class="foto-preview" onclick="ampliarFoto()">
                                    <button type="button" class="btn btn-danger btn-small" onclick="removerFotoReprodutor()" style="margin-top: 0.5rem; width: 100%;">üóëÔ∏è Remover Foto</button>
                                </div>
                            </div>
                            
                            <div class="grid-2">
                                <div class="form-group">
                                    <label>Ra√ßa</label>
                                    <select id="racaReprodutor"></select>
                                </div>
                                <div class="form-group">
                                    <label>Tipo</label>
                                    <select id="tipoReprodutor">
                                        <option value="Touro">Touro (Pr√≥prio)</option>
                                        <option value="S√™men">S√™men</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Propriet√°rio</label>
                                <select id="propReprodutor"></select>
                            </div>
                            <div class="form-group">
                                <label>Local/Pasto</label>
                                <select id="localReprodutor"></select>
                            </div>
                            <div class="form-group">
                                <label>Origem/Central</label>
                                <input type="text" id="origemReprodutor" placeholder="Ex: Central de S√™men XYZ">
                            </div>
                            <div class="grid-2">
                                <div class="form-group">
                                    <label>Nascimento</label>
                                    <input type="date" id="nascReprodutor">
                                </div>
                                <div class="form-group">
                                    <label>Status</label>
                                    <select id="statusReprodutor">
                                        <option value="Ativo">Ativo</option>
                                        <option value="Inativo">Inativo</option>
                                        <option value="Descartado">Descartado</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Observa√ß√µes</label>
                                <textarea id="obsReprodutor" rows="3" placeholder="Informa√ß√µes adicionais sobre o reprodutor"></textarea>
                            </div>
                            <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                <button type="submit" class="btn btn-primary">üíæ Salvar</button>
                                <button type="button" class="btn btn-warning" onclick="limparFormReprodutor()">üîÑ Novo</button>
                            </div>
                            <button type="button" class="btn btn-danger" onclick="excluirReprodutor()" style="width: 100%; margin-top: 10px;">üóëÔ∏è Excluir</button>
                        </form>
                    </div>

                    <div class="card">
                        <div style="display:flex; justify-content: space-between; margin-bottom: 1.5rem; gap: 1rem; flex-wrap: wrap;">
                            <input type="text" id="pesquisaReprodutor" placeholder="üîç Pesquisar reprodutor..." style="flex: 1; min-width: 200px; padding: 0.8rem; border: 2px solid #e2e8f0; border-radius: 0.7rem;" onkeyup="pesquisarReprodutores(this.value)">
                            <button class="btn btn-success" onclick="exportarReprodutoresExcel()">üìä Excel</button>
                        </div>
                        <div style="overflow-x: auto;">
                            <table>
                                <thead>
                                    <tr>
                                        <th>üì∏</th>
                                        <th>üî¢ Registro</th>
                                        <th>üìù Nome</th>
                                        <th>üêÑ Ra√ßa</th>
                                        <th>üè∑Ô∏è Tipo</th>
                                        <th>üìç Local</th>
                                        <th>‚úÖ Status</th>
                                    </tr>
                                </thead>
                                <tbody id="tabelaReprodutores"></tbody>
                            </table>
                        </div>
                        <div style="margin-top: 2rem; padding: 1.5rem; background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); border-radius: 1rem;">
                            <h3 style="margin-bottom: 1rem;">üìä Estat√≠sticas</h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
                                <div style="text-align: center;">
                                    <div style="font-size: 2rem; font-weight: 800; color: #3b82f6;" id="totalReprodutores">0</div>
                                    <div style="color: #64748b; font-size: 0.9rem;">Total</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 2rem; font-weight: 800; color: #22c55e;" id="reprodutoresAtivos">0</div>
                                    <div style="color: #64748b; font-size: 0.9rem;">Ativos</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 2rem; font-weight: 800; color: #f59e0b;" id="reprodutoresTouros">0</div>
                                    <div style="color: #64748b; font-size: 0.9rem;">Touros</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 2rem; font-weight: 800; color: #8b5cf6;" id="reprodutoresSemen">0</div>
                                    <div style="color: #64748b; font-size: 0.9rem;">S√™men</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TAB DASHBOARD -->
            <div id="tab-reports" class="tab-content hidden">
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>üêÆ Total</h3>
                        <div id="totalAnimais" style="font-size: 3rem; font-weight: 800;">0</div>
                    </div>
                    <div class="stat-card" style="border-bottom-color: #ec4899;">
                        <h3>‚ôÄ F√™meas</h3>
                        <div id="totalFemeas" style="font-size: 3rem; font-weight: 800; color: #ec4899;">0</div>
                    </div>
                    <div class="stat-card" style="border-bottom-color: #3b82f6;">
                        <h3>‚ôÇ Machos</h3>
                        <div id="totalMachos" style="font-size: 3rem; font-weight: 800; color: #3b82f6;">0</div>
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(450px, 1fr)); gap: 2rem;">
                    <div class="card"><canvas id="racaChart"></canvas></div>
                    <div class="card"><canvas id="localChart"></canvas></div>
                </div>
            </div>

            <!-- TAB RELAT√ìRIOS -->
            <div id="tab-relatorios" class="tab-content hidden">
                <div class="card">
                    <h2>üìÑ Relat√≥rios Gerenciais</h2>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5rem;">
                        <div class="item-box" onclick="gerarRelatorioCompleto()" style="background: linear-gradient(135deg, #dbeafe, #bfdbfe); cursor: pointer;">
                            <div>
                                <div style="font-size: 1.2rem; font-weight: 700;">üìã Completo</div>
                                <div style="color: #64748b; font-size: 0.9rem;">Todos os animais + reprodutores</div>
                            </div>
                            <div style="font-size: 2rem;">üìä</div>
                        </div>
                        <div class="item-box" onclick="gerarRelatorioPorRaca()" style="background: linear-gradient(135deg, #fce7f3, #fbcfe8); cursor: pointer;">
                            <div>
                                <div style="font-size: 1.2rem; font-weight: 700;">üêÑ Por Ra√ßa</div>
                                <div style="color: #64748b; font-size: 0.9rem;">Agrupado</div>
                            </div>
                            <div style="font-size: 2rem;">üè∑Ô∏è</div>
                        </div>
                        <div class="item-box" onclick="gerarRelatorioFemeas()" style="background: linear-gradient(135deg, #fef3c7, #fde68a); cursor: pointer;">
                            <div>
                                <div style="font-size: 1.2rem; font-weight: 700;">‚ôÄ F√™meas</div>
                                <div style="color: #64748b; font-size: 0.9rem;">Matrizes</div>
                            </div>
                            <div style="font-size: 2rem;">üêÆ</div>
                        </div>
                        <div class="item-box" onclick="gerarRelatorioPorProprietario()" style="background: linear-gradient(135deg, #e0e7ff, #c7d2fe); cursor: pointer;">
                            <div>
                                <div style="font-size: 1.2rem; font-weight: 700;">üë• Propriet√°rios</div>
                                <div style="color: #64748b; font-size: 0.9rem;">Por dono</div>
                            </div>
                            <div style="font-size: 2rem;">üë§</div>
                        </div>
                        <div class="item-box" onclick="gerarRelatorioAmamentando()" style="background: linear-gradient(135deg, #fce7f3, #fbcfe8); cursor: pointer;">
                            <div>
                                <div style="font-size: 1.2rem; font-weight: 700;">üçº Amamentando</div>
                                <div style="color: #64748b; font-size: 0.9rem;">F√™meas lactantes</div>
                            </div>
                            <div style="font-size: 2rem;">üë∂</div>
                        </div>
                        <div class="item-box" onclick="gerarRelatorioSemFerro()" style="background: linear-gradient(135deg, #fed7aa, #fdba74); cursor: pointer;">
                            <div>
                                <div style="font-size: 1.2rem; font-weight: 700;">üîì Sem Ferro</div>
                                <div style="color: #64748b; font-size: 0.9rem;">N√£o marcados</div>
                            </div>
                            <div style="font-size: 2rem;">üö´</div>
                        </div>
                    </div>
                    <div id="previewRelatorio" style="margin-top: 2rem; display: none;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 1rem;">
                            <h3 id="tituloRelatorio"></h3>
                            <button class="btn btn-warning" onclick="fecharRelatorio()">‚úñÔ∏è Fechar</button>
                        </div>
                        <div id="conteudoRelatorio" style="padding: 2rem; background: #f8fafc; border-radius: 1rem;"></div>
                    </div>
                </div>
            </div>

            <!-- TAB GENEALOGIA EXPANDIDA -->
            <div id="tab-genealogy" class="tab-content hidden">
                <div class="card">
                    <h2>üå≥ √Årvore Geneal√≥gica Completa</h2>
                    <select id="animalGenealogia" onchange="mostrarGenealogia()" style="padding:1rem; width:100%; margin-bottom: 1.5rem; border: 2px solid #e2e8f0; border-radius: 0.7rem;"></select>
                    <div id="arvoreGenealogia" style="padding: 2rem; background: #f8fafc; border-radius: 1rem; min-height: 600px;"></div>
                </div>
            </div>

            <!-- TAB RA√áAS/LOCAIS -->
            <div id="tab-racas" class="tab-content hidden">
                <div class="grid-2">
                    <div class="card">
                        <h2>üè∑Ô∏è Ra√ßas</h2>
                        <div class="form-group">
                            <input type="text" id="novaRaca" placeholder="Nome da Ra√ßa">
                        </div>
                        <button class="btn btn-primary" onclick="adicionarRaca()">‚ûï Adicionar</button>
                        <div id="listaRacas" style="margin-top: 1.5rem;"></div>
                    </div>
                    <div class="card">
                        <h2>üìç Pastos</h2>
                        <div class="form-group">
                            <input type="text" id="novoLocal" placeholder="Nome do Pasto">
                        </div>
                        <button class="btn btn-primary" onclick="adicionarLocal()">‚ûï Adicionar</button>
                        <div id="listaLocais" style="margin-top: 1.5rem;"></div>
                    </div>
                </div>
            </div>

            <!-- TAB PROPRIET√ÅRIOS -->
            <div id="tab-owners" class="tab-content hidden">
                <div class="card">
                    <h2>üë• Gerenciar Propriet√°rios</h2>
                    <div class="form-group">
                        <input type="text" id="novoProprietario" placeholder="Nome do Propriet√°rio">
                    </div>
                    <button class="btn btn-primary" onclick="adicionarProprietario()">‚ûï Adicionar Propriet√°rio</button>
                    <div id="listaProprietarios" style="margin-top: 1.5rem;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para ampliar foto -->
    <div id="modalFoto" class="modal" onclick="fecharModal()">
        <span class="close-modal">&times;</span>
        <img class="modal-content" id="imgAmpliada">
    </div>

    <script>
        let animais = [];
        let racas = ['NELORE', 'ANGUS', 'BRAHMAN', 'GIROLAND'];
        let locais = ['PASTO 01', 'PASTO 02', 'CURRAL'];
        let proprietarios = ['FAZENDA PR√ìPRIA'];
        let reprodutores = [];
        let animalAtualId = null;
        let reprodutorAtualId = null;
        let charts = {};
        let fotoAtual = null;
        let fotoAtualReprodutor = null;

        window.onload = async () => {
            setTimeout(async () => {
                await carregarDados();
                renderizarTabela();
                atualizarSelects();
                renderListas();
            }, 500);
        };

        async function carregarDados() {
            if (!window.firebaseDB) return;
            const { database, ref, get } = window.firebaseDB;
            
            try {
                const snapshot = await get(ref(database, 'animais'));
                if (snapshot.exists()) {
                    animais = Object.values(snapshot.val());
                    atualizarStatusSync(true);
                }
            } catch (e) {
                console.log('Erro ao carregar animais:', e);
            }

            try {
                const racasSnap = await get(ref(database, 'racas'));
                if (racasSnap.exists()) racas = racasSnap.val();
            } catch (e) {}

            try {
                const locaisSnap = await get(ref(database, 'locais'));
                if (locaisSnap.exists()) locais = locaisSnap.val();
            } catch (e) {}

            try {
                const propsSnap = await get(ref(database, 'proprietarios'));
                if (propsSnap.exists()) proprietarios = propsSnap.val();
            } catch (e) {}

            try {
                const reprodSnap = await get(ref(database, 'reprodutores'));
                if (reprodSnap.exists()) reprodutores = Object.values(reprodSnap.val());
            } catch (e) {}
        }

        async function salvarDadosOnline() {
            if (!window.firebaseDB) return false;
            const { database, ref, set } = window.firebaseDB;
            
            try {
                const animaisObj = {};
                animais.forEach(a => { animaisObj[a.id] = a; });
                
                await set(ref(database, 'animais'), animaisObj);
                await set(ref(database, 'racas'), racas);
                await set(ref(database, 'locais'), locais);
                await set(ref(database, 'proprietarios'), proprietarios);
                
                const reprodutoresObj = {};
                reprodutores.forEach(r => { reprodutoresObj[r.id] = r; });
                await set(ref(database, 'reprodutores'), reprodutoresObj);
                
                atualizarStatusSync(true);
                return true;
            } catch (e) {
                console.error('Erro ao salvar:', e);
                return false;
            }
        }

        async function sincronizarDados() {
            const btn = document.getElementById('syncStatus');
            const txt = document.getElementById('syncText');
            btn.style.pointerEvents = 'none';
            txt.innerText = '‚è≥ Sincronizando...';

            const ok = await salvarDadosOnline();

            btn.style.pointerEvents = 'auto';
            if (ok) {
                alert('‚úÖ Dados sincronizados!');
            } else {
                txt.innerText = 'üîÑ Sincronizar';
                alert('‚ùå Erro ao sincronizar!');
            }
        }

        function atualizarStatusSync(online) {
            const status = document.getElementById('syncStatus');
            const text = document.getElementById('syncText');
            if (online) {
                status.classList.add('online');
                text.innerText = '‚òÅÔ∏è Online';
            } else {
                status.classList.remove('online');
                text.innerText = 'üîÑ Sincronizar';
            }
        }

        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden'));
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.getElementById('tab-' + tabName).classList.remove('hidden');
            event.currentTarget.classList.add('active');
            if (tabName === 'reports') atualizarDashboard();
            if (tabName === 'reprodutores') {
                renderizarTabelaReprodutores();
                atualizarSelectsReprodutores();
            }
        }

        // FORMATA√á√ÉO DE N√öMERO COM M√çNIMO 2 D√çGITOS
        function formatarNumero(num) {
            return num.toString().padStart(2, '0');
        }

        function ordenarAnimaisPorNumero(lista) {
            return [...lista].sort((a, b) => {
                const numA = parseInt(a.numero) || 0;
                const numB = parseInt(b.numero) || 0;
                return numA - numB;
            });
        }

        // FUN√á√ïES DE FOTO
        function previewFoto(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    fotoAtual = e.target.result;
                    document.getElementById('fotoPreview').src = fotoAtual;
                    document.getElementById('fotoContainer').style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        }

        function removerFoto() {
            fotoAtual = null;
            document.getElementById('fotoAnimal').value = '';
            document.getElementById('fotoContainer').style.display = 'none';
        }

        function previewFotoReprodutor(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    fotoAtualReprodutor = e.target.result;
                    document.getElementById('fotoPreviewReprodutor').src = fotoAtualReprodutor;
                    document.getElementById('fotoContainerReprodutor').style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        }

        function removerFotoReprodutor() {
            fotoAtualReprodutor = null;
            document.getElementById('fotoReprodutor').value = '';
            document.getElementById('fotoContainerReprodutor').style.display = 'none';
        }

        function ampliarFoto() {
            const modal = document.getElementById('modalFoto');
            const img = document.getElementById('imgAmpliada');
            const fotoSrc = event.target.src;
            img.src = fotoSrc;
            modal.style.display = 'block';
        }

        function fecharModal() {
            document.getElementById('modalFoto').style.display = 'none';
        }

        async function salvarAnimal(e) {
            e.preventDefault();
            
            const numero = document.getElementById('numero').value.trim();
            
            const numeroJaExiste = animais.some(a => 
                a.numero === numero && a.id !== animalAtualId
            );
            
            if (numeroJaExiste) {
                alert('‚ö†Ô∏è Este n√∫mero j√° est√° cadastrado!');
                return;
            }
            
            const animal = {
                id: animalAtualId || Date.now().toString(),
                numero: formatarNumero(numero),
                brinco: document.getElementById('temBrinco').checked ? document.getElementById('brinco').value : '',
                nome: document.getElementById('nome').value,
                sexo: document.getElementById('sexo').value,
                raca: document.getElementById('raca').value,
                local: document.getElementById('local').value,
                proprietario: document.getElementById('proprietario').value,
                dataNascimento: document.getElementById('dataNascimento').value,
                pai: document.getElementById('pai').value,
                mae: document.getElementById('mae').value,
                semFerro: document.getElementById('semFerro').checked,
                amamentando: document.getElementById('amamentando').checked,
                foto: fotoAtual || ''
            };

            if (animalAtualId) {
                const idx = animais.findIndex(a => a.id === animalAtualId);
                if (idx !== -1) {
                    animais[idx] = animal;
                }
            } else {
                animais.push(animal);
            }

            await salvarDadosOnline();
            renderizarTabela();
            atualizarSelects();
            limparForm();
            alert("‚úÖ Animal salvo com sucesso!");
        }

        async function excluirAnimal() {
            if (!animalAtualId) {
                alert("‚ö†Ô∏è Selecione um animal!");
                return;
            }
            if (confirm("üóëÔ∏è Excluir este animal?")) {
                animais = animais.filter(a => a.id !== animalAtualId);
                await salvarDadosOnline();
                renderizarTabela();
                atualizarSelects();
                limparForm();
            }
        }

        function selecionarAnimal(id) {
            const a = animais.find(x => x.id === id);
            if (!a) return;
            
            animalAtualId = id;
            document.getElementById('numero').value = a.numero;
            
            if (a.brinco) {
                document.getElementById('temBrinco').checked = true;
                document.getElementById('brinco').style.display = 'block';
                document.getElementById('brinco').value = a.brinco;
            } else {
                document.getElementById('temBrinco').checked = false;
                document.getElementById('brinco').style.display = 'none';
                document.getElementById('brinco').value = '';
            }
            
            document.getElementById('nome').value = a.nome || '';
            document.getElementById('sexo').value = a.sexo;
            document.getElementById('raca').value = a.raca;
            document.getElementById('local').value = a.local;
            document.getElementById('proprietario').value = a.proprietario || '';
            document.getElementById('dataNascimento').value = a.dataNascimento || '';
            document.getElementById('pai').value = a.pai || '';
            document.getElementById('mae').value = a.mae || '';
            document.getElementById('semFerro').checked = a.semFerro || false;
            document.getElementById('amamentando').checked = a.amamentando || false;
            
            // Carregar foto
            if (a.foto) {
                fotoAtual = a.foto;
                document.getElementById('fotoPreview').src = a.foto;
                document.getElementById('fotoContainer').style.display = 'block';
            } else {
                removerFoto();
            }
        }

        function limparForm() {
            animalAtualId = null;
            document.getElementById('animalForm').reset();
            document.getElementById('temBrinco').checked = false;
            document.getElementById('brinco').style.display = 'none';
            removerFoto();
        }

        function toggleBrinco() {
            const campo = document.getElementById('brinco');
            campo.style.display = document.getElementById('temBrinco').checked ? 'block' : 'none';
        }

        function gerarNumero() {
            const max = animais.length > 0 ? Math.max(...animais.map(a => parseInt(a.numero) || 0)) : 0;
            document.getElementById('numero').value = formatarNumero(max + 1);
        }

        function renderizarTabela(data = animais) {
            const tbody = document.getElementById('tabelaAnimais');
            
            const animaisOrdenados = ordenarAnimaisPorNumero(data);
            const reprodutoresAtivos = reprodutores.filter(r => r.status === 'Ativo');
            
            let proximoNumero = 1;
            if (animais.length > 0) {
                const maiorNumero = Math.max(...animais.map(a => parseInt(a.numero) || 0));
                proximoNumero = maiorNumero + 1;
            }
            
            const todosRegistros = [
                ...animaisOrdenados,
                ...reprodutoresAtivos.map((r, index) => ({
                    id: `reprodutor_${r.id}`,
                    numero: formatarNumero(proximoNumero + index),
                    nome: `${r.nome} (Reprodutor)`,
                    sexo: 'M',
                    raca: r.raca,
                    local: r.local,
                    dataNascimento: r.dataNascimento,
                    foto: r.foto || '',
                    isReprodutor: true,
                    reprodutorOriginal: r
                }))
            ];
            
            if (todosRegistros.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #94a3b8; padding: 2rem;">Nenhum animal cadastrado</td></tr>';
                return;
            }
            
            tbody.innerHTML = todosRegistros.map(a => {
                const idade = calcularIdade(a.dataNascimento);
                const sexoBadge = a.sexo === 'F' ? '<span class="badge badge-pink">‚ôÄ</span>' : '<span class="badge badge-blue">‚ôÇ</span>';
                
                let corLinha = '';
                if (a.isReprodutor) {
                    corLinha = 'background: linear-gradient(90deg, #dbeafe 0%, #bfdbfe 100%);';
                } else if (a.amamentando) {
                    corLinha = 'background: linear-gradient(90deg, #d1fae5 0%, #a7f3d0 100%);';
                } else if (a.semFerro) {
                    corLinha = 'background: linear-gradient(90deg, #fecaca 0%, #fca5a5 100%);';
                }
                
                const nomeExibir = a.isReprodutor 
                    ? `<strong>${a.nome}</strong> <span class="badge" style="background: #3b82f6; color: white; font-size: 0.7rem;">üêÇ REPRODUTOR</span>`
                    : (a.nome || '-');
                
                const onclickAction = a.isReprodutor 
                    ? `selecionarReprodutor('${a.reprodutorOriginal.id}')`
                    : `selecionarAnimal('${a.id}')`;
                
                const fotoHTML = a.foto 
                    ? `<img src="${a.foto}" style="width: 40px; height: 40px; border-radius: 0.5rem; object-fit: cover; cursor: pointer;" onclick="event.stopPropagation(); ampliarFotoTabela('${a.foto}')">`
                    : '<div style="width: 40px; height: 40px; background: #f1f5f9; border-radius: 0.5rem; display: flex; align-items: center; justify-content: center; font-size: 1.2rem;">üì∑</div>';
                
                return `
                    <tr onclick="${onclickAction}" style="${corLinha}">
                        <td>${fotoHTML}</td>
                        <td><strong>${a.numero}</strong></td>
                        <td>${nomeExibir}</td>
                        <td>${sexoBadge}</td>
                        <td>${a.raca}</td>
                        <td>${a.local}</td>
                        <td>${idade}</td>
                    </tr>
                `;
            }).join('');
        }

        function ampliarFotoTabela(fotoSrc) {
            const modal = document.getElementById('modalFoto');
            const img = document.getElementById('imgAmpliada');
            img.src = fotoSrc;
            modal.style.display = 'block';
        }

        function calcularIdade(dataNasc) {
            if (!dataNasc) return '-';
            const hoje = new Date();
            const nasc = new Date(dataNasc);
            const diffDays = Math.ceil((hoje - nasc) / (1000 * 60 * 60 * 24));
            if (diffDays < 30) return `${diffDays}d`;
            if (diffDays < 365) return `${Math.floor(diffDays / 30)}m`;
            const anos = Math.floor(diffDays / 365);
            const meses = Math.floor((diffDays % 365) / 30);
            return meses > 0 ? `${anos}a ${meses}m` : `${anos}a`;
        }

        function pesquisarAnimais(val) {
            const filtrados = animais.filter(a =>
                a.numero.toLowerCase().includes(val.toLowerCase()) ||
                (a.nome && a.nome.toLowerCase().includes(val.toLowerCase())) ||
                (a.raca && a.raca.toLowerCase().includes(val.toLowerCase()))
            );
            renderizarTabela(filtrados);
        }

        function atualizarSelects() {
            document.getElementById('raca').innerHTML = racas.map(r => `<option value="${r}">${r}</option>`).join('');
            document.getElementById('local').innerHTML = locais.map(l => `<option value="${l}">${l}</option>`).join('');
            document.getElementById('proprietario').innerHTML = proprietarios.map(p => `<option value="${p}">${p}</option>`).join('');
            
            const machos = ordenarAnimaisPorNumero(animais.filter(a => a.sexo === 'M'));
            const femeas = ordenarAnimaisPorNumero(animais.filter(a => a.sexo === 'F'));
            
            const reprodutoresMachos = reprodutores
                .filter(r => r.status === 'Ativo')
                .sort((a, b) => a.registro.localeCompare(b.registro));
            
            let optionsPai = '<option value="">N√£o informado</option>';
            
            if (reprodutoresMachos.length > 0) {
                optionsPai += '<optgroup label="üêÇ Reprodutores">';
                reprodutoresMachos.forEach(r => {
                    optionsPai += `<option value="reprodutor_${r.id}">üêÇ ${r.registro} - ${r.nome}</option>`;
                });
                optionsPai += '</optgroup>';
            }
            // ATUALIZAR SELECTS
    function atualizarSelects() {
        document.getElementById('raca').innerHTML = racas.map(r => `<option value="${r}">${r}</option>`).join('');
        document.getElementById('local').innerHTML = locais.map(l => `<option value="${l}">${l}</option>`).join('');
        document.getElementById('proprietario').innerHTML = proprietarios.map(p => `<option value="${p}">${p}</option>`).join('');
        
        const machos = ordenarAnimaisPorNumero(animais.filter(a => a.sexo === 'M'));
        const femeas = ordenarAnimaisPorNumero(animais.filter(a => a.sexo === 'F'));
        
        // TODOS os reprodutores (n√£o apenas ativos)
        const todosReprodutores = reprodutores
            .sort((a, b) => a.registro.localeCompare(b.registro));
        
        let optionsPai = '<option value="">Indefinido</option>';
        optionsPai += '<option value="manual">‚úèÔ∏è Digitar manualmente...</option>';
        
        if (todosReprodutores.length > 0) {
            optionsPai += '<optgroup label="üêÇ Reprodutores">';
            todosReprodutores.forEach(r => {
                const statusIcon = r.status === 'Ativo' ? '‚úì' : r.status === 'Inativo' ? '‚è∏' : '‚úó';
                optionsPai += `<option value="reprodutor_${r.id}">${statusIcon} ${r.registro} - ${r.nome} (${r.tipo})</option>`;
            });
            optionsPai += '</optgroup>';
        }
        
        if (machos.length > 0) {
            optionsPai += '<optgroup label="üêÆ Animais do Rebanho">';
            machos.forEach(a => {
                optionsPai += `<option value="${a.id}">${a.numero} - ${a.nome || 'Sem nome'}</option>`;
            });
            optionsPai += '</optgroup>';
        }
        
        document.getElementById('pai').innerHTML = optionsPai;
        
        // Permitir entrada manual para m√£e
        let optionsMae = '<option value="">Indefinida</option>';
        optionsMae += '<option value="manual">‚úèÔ∏è Digitar manualmente...</option>';
        if (femeas.length > 0) {
            optionsMae += '<optgroup label="üêÑ F√™meas do Rebanho">';
            femeas.forEach(a => {
                optionsMae += `<option value="${a.id}">${a.numero} - ${a.nome || 'Sem nome'}</option>`;
            });
            optionsMae += '</optgroup>';
        }
        
        document.getElementById('mae').innerHTML = optionsMae;
    }
   
            if (machos.length > 0) {
                optionsPai += '<optgroup label="üêÆ Animais do Rebanho">';
                machos.forEach(a => {
                    optionsPai += `<option value="${a.id}">${a.numero} - ${a.nome || 'Sem nome'}</option>`;
                });
                optionsPai += '</optgroup>';
            }
            
            document.getElementById('pai').innerHTML = optionsPai;
            
            document.getElementById('mae').innerHTML = '<option value="">N√£o informada</option>' + 
                femeas.map(a => `<option value="${a.id}">${a.numero} - ${a.nome || 'Sem nome'}</option>`).join('');
            
            const todosOrdenados = ordenarAnimaisPorNumero(animais);
            document.getElementById('animalGenealogia').innerHTML = '<option value="">Selecione...</option>' + 
                todosOrdenados.map(a => `<option value="${a.id}">${a.numero} - ${a.nome || 'Sem nome'}</option>`).join('');
        }

        async function adicionarRaca() {
            const val = document.getElementById('novaRaca').value.toUpperCase().trim();
            if (!val) return alert('‚ö†Ô∏è Digite o nome!');
            if (racas.includes(val)) return alert('‚ö†Ô∏è J√° existe!');
            racas.push(val);
            await salvarDadosOnline();
            document.getElementById('novaRaca').value = '';
            renderListas();
            atualizarSelects();
        }

        async function editarRaca(racaAntiga) {
            const novaRaca = prompt('‚úèÔ∏è Editar ra√ßa:', racaAntiga);
            if (!novaRaca || novaRaca.trim() === '') return;
            
            const racaEditada = novaRaca.toUpperCase().trim();
            if (racaEditada === racaAntiga) return;
            
            if (racas.includes(racaEditada)) {
                alert('‚ö†Ô∏è Esta ra√ßa j√° existe!');
                return;
            }
            
            animais.forEach(a => {
                if (a.raca === racaAntiga) a.raca = racaEditada;
            });
            
            const idx = racas.indexOf(racaAntiga);
            if (idx !== -1) racas[idx] = racaEditada;
            
            await salvarDadosOnline();
            renderListas();
            atualizarSelects();
            renderizarTabela();
        }

        async function excluirRaca(raca) {
            const animaisComRaca = animais.filter(a => a.raca === raca);
            if (animaisComRaca.length > 0) {
                alert(`‚ö†Ô∏è N√£o √© poss√≠vel excluir! Existem ${animaisComRaca.length} animais com esta ra√ßa.`);
                return;
            }
            
            if (!confirm(`üóëÔ∏è Excluir a ra√ßa "${raca}"?`)) return;
            
            racas = racas.filter(r => r !== raca);
            await salvarDadosOnline();
            renderListas();
            atualizarSelects();
        }

        async function adicionarLocal() {
            const val = document.getElementById('novoLocal').value.toUpperCase().trim();
            if (!val) return alert('‚ö†Ô∏è Digite o nome!');
            if (locais.includes(val)) return alert('‚ö†Ô∏è J√° existe!');
            locais.push(val);
            await salvarDadosOnline();
            document.getElementById('novoLocal').value = '';
            renderListas();
            atualizarSelects();
        }

        async function editarLocal(localAntigo) {
            const novoLocal = prompt('‚úèÔ∏è Editar pasto:', localAntigo);
            if (!novoLocal || novoLocal.trim() === '') return;
            
            const localEditado = novoLocal.toUpperCase().trim();
            if (localEditado === localAntigo) return;
            
            if (locais.includes(localEditado)) {
                alert('‚ö†Ô∏è Este pasto j√° existe!');
                return;
            }
            
            animais.forEach(a => {
                if (a.local === localAntigo) a.local = localEditado;
            });
            
            const idx = locais.indexOf(localAntigo);
            if (idx !== -1) locais[idx] = localEditado;
            
            await salvarDadosOnline();
            renderListas();
            atualizarSelects();
            renderizarTabela();
        }

        async function excluirLocal(local) {
            const animaisNoLocal = animais.filter(a => a.local === local);
            const reprodutoresNoLocal = reprodutores.filter(r => r.local === local);
            const totalNoLocal = animaisNoLocal.length + reprodutoresNoLocal.length;
            
            if (totalNoLocal > 0) {
                alert(`‚ö†Ô∏è N√£o √© poss√≠vel excluir! Existem ${animaisNoLocal.length} animais e ${reprodutoresNoLocal.length} reprodutores neste pasto.`);
                return;
            }
            
            if (!confirm(`üóëÔ∏è Excluir o pasto "${local}"?`)) return;
            
            locais = locais.filter(l => l !== local);
            await salvarDadosOnline();
            renderListas();
            atualizarSelects();
        }

        async function adicionarProprietario() {
            const val = document.getElementById('novoProprietario').value.toUpperCase().trim();
            if (!val) return alert('‚ö†Ô∏è Digite o nome!');
            if (proprietarios.includes(val)) return alert('‚ö†Ô∏è J√° existe!');
            proprietarios.push(val);
            await salvarDadosOnline();
            document.getElementById('novoProprietario').value = '';
            renderListas();
            atualizarSelects();
        }

        async function editarProprietario(propAntigo) {
            const novoProp = prompt('‚úèÔ∏è Editar propriet√°rio:', propAntigo);
            if (!novoProp || novoProp.trim() === '') return;
            
            const propEditado = novoProp.toUpperCase().trim();
            if (propEditado === propAntigo) return;
            
            if (proprietarios.includes(propEditado)) {
                alert('‚ö†Ô∏è Este propriet√°rio j√° existe!');
                return;
            }
            
            animais.forEach(a => {
                if (a.proprietario === propAntigo) a.proprietario = propEditado;
            });
            
            const idx = proprietarios.indexOf(propAntigo);
            if (idx !== -1) proprietarios[idx] = propEditado;
            
            await salvarDadosOnline();
            renderListas();
            atualizarSelects();
            renderizarTabela();
        }

        async function excluirProprietario(prop) {
            const animaisDoProp = animais.filter(a => a.proprietario === prop);
            if (animaisDoProp.length > 0) {
                alert(`‚ö†Ô∏è N√£o √© poss√≠vel excluir! Existem ${animaisDoProp.length} animais deste propriet√°rio.`);
                return;
            }
            
            if (!confirm(`üóëÔ∏è Excluir o propriet√°rio "${prop}"?`)) return;
            
            proprietarios = proprietarios.filter(p => p !== prop);
            await salvarDadosOnline();
            renderListas();
            atualizarSelects();
        }

        function renderListas() {
            document.getElementById('listaRacas').innerHTML = racas.map(r => `
                <div class="item-box">
                    <span>${r}</span>
                    <div class="btn-group">
                        <button class="btn btn-warning btn-small" onclick="editarRaca('${r}')">‚úèÔ∏è</button>
                        <button class="btn btn-danger btn-small" onclick="excluirRaca('${r}')">üóëÔ∏è</button>
                    </div>
                </div>
            `).join('');
            
            document.getElementById('listaLocais').innerHTML = locais.map(l => `
                <div class="item-box">
                    <span>${l}</span>
                    <div class="btn-group">
                        <button class="btn btn-warning btn-small" onclick="editarLocal('${l}')">‚úèÔ∏è</button>
                        <button class="btn btn-danger btn-small" onclick="excluirLocal('${l}')">üóëÔ∏è</button>
                    </div>
                </div>
            `).join('');
            
            document.getElementById('listaProprietarios').innerHTML = proprietarios.map(p => `
                <div class="item-box">
                    <span>${p}</span>
                    <div class="btn-group">
                        <button class="btn btn-warning btn-small" onclick="editarProprietario('${p}')">‚úèÔ∏è</button>
                        <button class="btn btn-danger btn-small" onclick="excluirProprietario('${p}')">üóëÔ∏è</button>
                    </div>
                </div>
            `).join('');
        }

        function atualizarDashboard() {
            document.getElementById('totalAnimais').innerText = animais.length;
            document.getElementById('totalFemeas').innerText = animais.filter(a => a.sexo === 'F').length;
            document.getElementById('totalMachos').innerText = animais.filter(a => a.sexo === 'M').length;

            if (charts.racaChart) charts.racaChart.destroy();
            if (charts.localChart) charts.localChart.destroy();

            const racaCounts = animais.reduce((acc, a) => {
                acc[a.raca] = (acc[a.raca] || 0) + 1;
                return acc;
            }, {});
            const localCounts = animais.reduce((acc, a) => {
                acc[a.local] = (acc[a.local] || 0) + 1;
                return acc;
            }, {});

            const cores = ['#3b82f6', '#ec4899', '#f59e0b', '#22c55e', '#8b5cf6'];

            charts.racaChart = new Chart(document.getElementById('racaChart'), {
                type: 'doughnut',
                data: {
                    labels: Object.keys(racaCounts),
                    datasets: [{
                        data: Object.values(racaCounts),
                        backgroundColor: cores
                    }]
                },
                options: {
                    plugins: {
                        title: {
                            display: true,
                            text: 'Por Ra√ßa',
                            font: { size: 16 }
                        }
                    }
                }
            });

            charts.localChart = new Chart(document.getElementById('localChart'), {
                type: 'bar',
                data: {
                    labels: Object.keys(localCounts),
                    datasets: [{
                        data: Object.values(localCounts),
                        backgroundColor: cores,
                        borderRadius: 8
                    }]
                },
                options: {
                    plugins: {
                        title: {
                            display: true,
                            text: 'Por Local',
                            font: { size: 16 }
                        },
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        // RELAT√ìRIOS COM REPRODUTORES ATIVOS
        function gerarRelatorioCompleto() {
            const reprodutoresAtivos = reprodutores.filter(r => r.status === 'Ativo');
            const total = animais.length + reprodutoresAtivos.length;
            
            if (total === 0) return alert('‚ö†Ô∏è Sem dados!');
            
            document.getElementById('tituloRelatorio').innerText = 'üìã Relat√≥rio Completo';
            document.getElementById('previewRelatorio').style.display = 'block';
            
            const ordenados = ordenarAnimaisPorNumero(animais);
            
            let html = '<table style="width:100%; background:white; border-radius:0.7rem;"><thead><tr style="background:#f1f5f9;"><th style="padding:1rem;">N¬∫</th><th style="padding:1rem;">Nome</th><th style="padding:1rem;">Sexo</th><th style="padding:1rem;">Ra√ßa</th><th style="padding:1rem;">Local</th><th style="padding:1rem;">Tipo</th></tr></thead><tbody>';
            
            ordenados.forEach(a => {
                html += `<tr><td style="padding:1rem;"><strong>${a.numero}</strong></td><td style="padding:1rem;">${a.nome || '-'}</td><td style="padding:1rem;">${a.sexo === 'F' ? '‚ôÄ' : '‚ôÇ'}</td><td style="padding:1rem;">${a.raca}</td><td style="padding:1rem;">${a.local}</td><td style="padding:1rem;">üêÆ Rebanho</td></tr>`;
            });
            
            reprodutoresAtivos.forEach(r => {
                html += `<tr style="background:#e0f2fe;"><td style="padding:1rem;"><strong>${r.registro}</strong></td><td style="padding:1rem;">${r.nome}</td><td style="padding:1rem;">‚ôÇ</td><td style="padding:1rem;">${r.raca}</td><td style="padding:1rem;">${r.local}</td><td style="padding:1rem;">üêÇ Reprodutor (${r.tipo})</td></tr>`;
            });
            
            html += '</tbody></table>';
            html += `<div style="margin-top:1rem; padding:1rem; background:#f1f5f9; border-radius:0.5rem;"><strong>Total:</strong> ${total} (${animais.length} animais + ${reprodutoresAtivos.length} reprodutores ativos)</div>`;
            
            document.getElementById('conteudoRelatorio').innerHTML = html;
        }

        function gerarRelatorioPorRaca() {
            const reprodutoresAtivos = reprodutores.filter(r => r.status === 'Ativo');
            const total = animais.length + reprodutoresAtivos.length;
            
            if (total === 0) return alert('‚ö†Ô∏è Sem dados!');
            
            document.getElementById('tituloRelatorio').innerText = 'üêÑ Por Ra√ßa';
            document.getElementById('previewRelatorio').style.display = 'block';
            
            const porRaca = {};
            
            animais.forEach(a => {
                if (!porRaca[a.raca]) porRaca[a.raca] = { animais: [], reprodutores: [] };
                porRaca[a.raca].animais.push(a);
            });
            
            reprodutoresAtivos.forEach(r => {
                if (!porRaca[r.raca]) porRaca[r.raca] = { animais: [], reprodutores: [] };
                porRaca[r.raca].reprodutores.push(r);
            });
            
            let html = '';
            Object.keys(porRaca).sort().forEach(raca => {
                const dados = porRaca[raca];
                const ordenados = ordenarAnimaisPorNumero(dados.animais);
                const totalRaca = dados.animais.length + dados.reprodutores.length;
                
                html += `<div style="background:white; padding:1.5rem; border-radius:0.7rem; margin-bottom:1rem;"><h3>${raca} (${totalRaca} - ${dados.animais.length} animais + ${dados.reprodutores.length} reprodutores)</h3>`;
                
                ordenados.forEach(a => {
                    html += `<div style="padding:0.5rem; background:#f8fafc; margin:0.3rem 0; border-radius:0.5rem;"><strong>${a.numero}</strong> - ${a.nome || '-'} (${a.sexo === 'F' ? '‚ôÄ' : '‚ôÇ'})</div>`;
                });
                
                dados.reprodutores.forEach(r => {
                    html += `<div style="padding:0.5rem; background:#e0f2fe; margin:0.3rem 0; border-radius:0.5rem; border-left:3px solid #3b82f6;"><strong>${r.registro}</strong> - ${r.nome} (üêÇ Reprodutor ${r.tipo})</div>`;
                });
                
                html += '</div>';
            });
            document.getElementById('conteudoRelatorio').innerHTML = html;
        }

        function gerarRelatorioFemeas() {
            const femeas = ordenarAnimaisPorNumero(animais.filter(a => a.sexo === 'F'));
            if (femeas.length === 0) return alert('‚ö†Ô∏è Sem f√™meas!');
            document.getElementById('tituloRelatorio').innerText = '‚ôÄ F√™meas';
            document.getElementById('previewRelatorio').style.display = 'block';
            let html = '<div style="background:white; padding:1.5rem; border-radius:0.7rem;">';
            femeas.forEach(a => {
                html += `<div style="padding:1rem; background:#fef3f2; margin:0.5rem 0; border-radius:0.5rem; border-left:4px solid #ec4899;"><strong>${a.numero} - ${a.nome || '-'}</strong><br><span style="color:#64748b;">${a.raca} | ${a.local}</span></div>`;
            });
            html += '</div>';
            document.getElementById('conteudoRelatorio').innerHTML = html;
        }

        function gerarRelatorioPorProprietario() {
            const reprodutoresAtivos = reprodutores.filter(r => r.status === 'Ativo');
            const total = animais.length + reprodutoresAtivos.length;
            
            if (total === 0) return alert('‚ö†Ô∏è Sem dados!');
            
            document.getElementById('tituloRelatorio').innerText = 'üë• Por Propriet√°rio';
            document.getElementById('previewRelatorio').style.display = 'block';
            
            const porProprietario = {};
            animais.forEach(a => {
                if (!porProprietario[a.proprietario]) porProprietario[a.proprietario] = { animais: [], reprodutores: [] };
                porProprietario[a.proprietario].animais.push(a);
            });
            
            reprodutoresAtivos.forEach(r => {
                if (!porProprietario[r.proprietario]) porProprietario[r.proprietario] = { animais: [], reprodutores: [] };
                porProprietario[r.proprietario].reprodutores.push(r);
            });
            
            let html = '';
            Object.keys(porProprietario).forEach(prop => {
                const dados = porProprietario[prop];
                const lista = ordenarAnimaisPorNumero(dados.animais);
                const femeas = lista.filter(a => a.sexo === 'F').length;
                const machos = lista.filter(a => a.sexo === 'M').length;
                const totalProp = dados.animais.length + dados.reprodutores.length;
                
                html += `<div style="background:white; padding:1.5rem; border-radius:0.7rem; margin-bottom:1rem; border-left:4px solid #3b82f6;">
                    <h3 style="margin-bottom:1rem;">${prop} <span style="color:#64748b; font-size:0.9rem;">(${totalProp} - ${dados.animais.length} animais [${femeas}‚ôÄ ${machos}‚ôÇ] + ${dados.reprodutores.length} reprodutores)</span></h3>`;
                
                lista.forEach(a => {
                    html += `<div style="padding:0.7rem; background:#f8fafc; margin:0.3rem 0; border-radius:0.5rem; display:flex; justify-content:space-between;">
                        <span><strong>${a.numero}</strong> - ${a.nome || '-'} ${a.sexo === 'F' ? '‚ôÄ' : '‚ôÇ'}</span>
                        <span style="color:#64748b;">${a.raca} | ${a.local}</span>
                    </div>`;
                });
                
                dados.reprodutores.forEach(r => {
                    html += `<div style="padding:0.7rem; background:#e0f2fe; margin:0.3rem 0; border-radius:0.5rem; display:flex; justify-content:space-between; border-left:3px solid #3b82f6;">
                        <span><strong>${r.registro}</strong> - ${r.nome} üêÇ</span>
                        <span style="color:#64748b;">${r.raca} | ${r.local} | ${r.tipo}</span>
                    </div>`;
                });
                
                html += '</div>';
            });
            document.getElementById('conteudoRelatorio').innerHTML = html;
        }

        function gerarRelatorioAmamentando() {
            const amamentando = ordenarAnimaisPorNumero(animais.filter(a => a.amamentando === true));
            if (amamentando.length === 0) return alert('‚ö†Ô∏è Nenhuma f√™mea amamentando!');
            document.getElementById('tituloRelatorio').innerText = 'üçº F√™meas Amamentando';
            document.getElementById('previewRelatorio').style.display = 'block';
            let html = `<div style="background:white; padding:1.5rem; border-radius:0.7rem;">
                <div style="background:#fce7f3; padding:1rem; border-radius:0.5rem; margin-bottom:1rem; text-align:center;">
                    <strong style="font-size:1.5rem; color:#be185d;">${amamentando.length}</strong>
                    <div style="color:#64748b;">f√™meas em lacta√ß√£o</div>
                </div>`;
            amamentando.forEach(a => {
                const idade = calcularIdade(a.dataNascimento);
                html += `<div style="padding:1rem; background:#fef3f2; margin:0.5rem 0; border-radius:0.5rem; border-left:4px solid #ec4899;">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <div>
                            <strong style="font-size:1.1rem;">${a.numero} - ${a.nome || '-'}</strong>
                            <div style="color:#64748b; font-size:0.9rem; margin-top:0.3rem;">
                                ${a.raca} | ${a.local} | ${a.proprietario}
                            </div>
                        </div>
                        <div style="text-align:right;">
                            <div style="background:#ec4899; color:white; padding:0.3rem 0.8rem; border-radius:1rem; font-size:0.8rem; font-weight:700;">
                                üçº Lactante
                            </div>
                            <div style="color:#64748b; font-size:0.85rem; margin-top:0.3rem;">Idade: ${idade}</div>
                        </div>
                    </div>
                </div>`;
            });
            html += '</div>';
            document.getElementById('conteudoRelatorio').innerHTML = html;
        }

        function gerarRelatorioSemFerro() {
            const semFerro = ordenarAnimaisPorNumero(animais.filter(a => a.semFerro === true));
            if (semFerro.length === 0) return alert('‚ö†Ô∏è Todos os animais est√£o marcados!');
            document.getElementById('tituloRelatorio').innerText = 'üîì Animais Sem Ferro';
            document.getElementById('previewRelatorio').style.display = 'block';
            let html = `<div style="background:white; padding:1.5rem; border-radius:0.7rem;">
                <div style="background:#fed7aa; padding:1rem; border-radius:0.5rem; margin-bottom:1rem; text-align:center;">
                    <strong style="font-size:1.5rem; color:#c2410c;">${semFerro.length}</strong>
                    <div style="color:#64748b;">animais sem marca√ß√£o</div>
                </div>`;
            semFerro.forEach(a => {
                const idade = calcularIdade(a.dataNascimento);
                const sexoBadge = a.sexo === 'F' ? '<span style="background:#fce7f3; color:#be185d; padding:0.3rem 0.6rem; border-radius:0.5rem; font-size:0.8rem; font-weight:700;">‚ôÄ</span>' : '<span style="background:#dbeafe; color:#1e40af; padding:0.3rem 0.6rem; border-radius:0.5rem; font-size:0.8rem; font-weight:700;">‚ôÇ</span>';
                html += `<div style="padding:1rem; background:#fef3f2; margin:0.5rem 0; border-radius:0.5rem; border-left:4px solid #f97316;">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <div>
                            <strong style="font-size:1.1rem;">${a.numero} - ${a.nome || '-'}</strong> ${sexoBadge}
                            <div style="color:#64748b; font-size:0.9rem; margin-top:0.3rem;">
                                ${a.raca} | ${a.local} | ${a.proprietario}
                            </div>
                        </div>
                        <div style="text-align:right;">
                            <div style="background:#f97316; color:white; padding:0.3rem 0.8rem; border-radius:1rem; font-size:0.8rem; font-weight:700;">
                                üîì Sem Ferro
                            </div>
                            <div style="color:#64748b; font-size:0.85rem; margin-top:0.3rem;">Idade: ${idade}</div>
                        </div>
                    </div>
                </div>`;
            });
            html += '</div>';
            document.getElementById('conteudoRelatorio').innerHTML = html;
        }

        function fecharRelatorio() {
            document.getElementById('previewRelatorio').style.display = 'none';
        }

        // GENEALOGIA EXPANDIDA COM AV√ìS E BISAV√ìS
        function mostrarGenealogia() {
            const id = document.getElementById('animalGenealogia').value;
            const a = animais.find(x => x.id === id);
            if (!a) {
                document.getElementById('arvoreGenealogia').innerHTML = '<div style="text-align:center; color:#94a3b8; padding:3rem;">Selecione um animal</div>';
                return;
            }
            
            // Buscar pai
            let pai = null;
            let paiInfo = { texto: 'N√£o registrado', dados: null };
            
            if (a.pai) {
                if (a.pai.startsWith('reprodutor_')) {
                    const reprodutorId = a.pai.replace('reprodutor_', '');
                    pai = reprodutores.find(x => x.id === reprodutorId);
                    if (pai) {
                        paiInfo.texto = `üêÇ ${pai.registro} - ${pai.nome}<br><span style="font-size:0.85rem;">${pai.raca} | ${pai.tipo}</span>`;
                        paiInfo.dados = pai;
                    }
                } else {
                    pai = animais.find(x => x.id === a.pai);
                    if (pai) {
                        paiInfo.texto = `${pai.numero} - ${pai.nome || 'Sem nome'}<br><span style="font-size:0.85rem;">${pai.raca}</span>`;
                        paiInfo.dados = pai;
                    }
                }
            }
            
            // Buscar m√£e
            const mae = a.mae ? animais.find(x => x.id === a.mae) : null;
            let maeInfo = { texto: 'N√£o registrada', dados: null };
            if (mae) {
                maeInfo.texto = `${mae.numero} - ${mae.nome || 'Sem nome'}<br><span style="font-size:0.85rem;">${mae.raca}</span>`;
                maeInfo.dados = mae;
            }
            
            // Buscar av√≥s paternos
            let avoPaterno = { texto: 'N√£o registrado' };
            let avoaPaterna = { texto: 'N√£o registrada' };
            
            if (paiInfo.dados && !paiInfo.dados.registro) { // Se pai √© animal, n√£o reprodutor
                if (paiInfo.dados.pai) {
                    if (paiInfo.dados.pai.startsWith('reprodutor_')) {
                        const repId = paiInfo.dados.pai.replace('reprodutor_', '');
                        const rep = reprodutores.find(x => x.id === repId);
                        if (rep) avoPaterno.texto = `üêÇ ${rep.registro} - ${rep.nome}`;
                    } else {
                        const av = animais.find(x => x.id === paiInfo.dados.pai);
                        if (av) avoPaterno.texto = `${av.numero} - ${av.nome || 'Sem nome'}`;
                    }
                }
                if (paiInfo.dados.mae) {
                    const av = animais.find(x => x.id === paiInfo.dados.mae);
                    if (av) avoaPaterna.texto = `${av.numero} - ${av.nome || 'Sem nome'}`;
                }
            }
            
            // Buscar av√≥s maternos
            let avoMaterno = { texto: 'N√£o registrado' };
            let avoaMaterna = { texto: 'N√£o registrada' };
            
            if (maeInfo.dados) {
                if (maeInfo.dados.pai) {
                    if (maeInfo.dados.pai.startsWith('reprodutor_')) {
                        const repId = maeInfo.dados.pai.replace('reprodutor_', '');
                        const rep = reprodutores.find(x => x.id === repId);
                        if (rep) avoMaterno.texto = `üêÇ ${rep.registro} - ${rep.nome}`;
                    } else {
                        const av = animais.find(x => x.id === maeInfo.dados.pai);
                        if (av) avoMaterno.texto = `${av.numero} - ${av.nome || 'Sem nome'}`;
                    }
                }
                if (maeInfo.dados.mae) {
                    const av = animais.find(x => x.id === maeInfo.dados.mae);
                    if (av) avoaMaterna.texto = `${av.numero} - ${av.nome || 'Sem nome'}`;
                }
            }
            
            document.getElementById('arvoreGenealogia').innerHTML = `
                <div style="text-align:center;">
                    <!-- ANIMAL PRINCIPAL -->
                    <div style="background:linear-gradient(135deg, #3b82f6, #2563eb); color:white; padding:2rem; border-radius:1.2rem; display:inline-block; min-width:300px; margin-bottom:2rem; box-shadow:0 10px 30px rgba(59,130,246,0.3);">
                        <div style="font-size:2rem; font-weight:800;">${a.numero}</div>
                        <div style="font-size:1.2rem; margin:0.5rem 0;">${a.nome || 'Sem nome'}</div>
                        <div style="font-size:0.9rem; opacity:0.9;">${a.sexo === 'F' ? '‚ôÄ' : '‚ôÇ'} ${a.raca} | ${a.local}</div>
                    </div>
                    
                    <!-- PAIS -->
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:1.5rem; max-width:1000px; margin:0 auto 2rem;">
                        <div style="padding:1.5rem; background:#dbeafe; border-radius:1rem; border:3px solid #3b82f6;">
                            <div style="font-weight:700; margin-bottom:0.8rem; color:#1e40af;">üêÇ PAI</div>
                            <div style="color:#1e293b;">${paiInfo.texto}</div>
                        </div>
                        <div style="padding:1.5rem; background:#fce7f3; border-radius:1rem; border:3px solid #ec4899;">
                            <div style="font-weight:700; margin-bottom:0.8rem; color:#be185d;">üêÑ M√ÉE</div>
                            <div style="color:#1e293b;">${maeInfo.texto}</div>
                        </div>
                    </div>
                    
                    <!-- AV√ìS -->
                    <div style="margin-bottom:1.5rem;">
                        <h3 style="margin-bottom:1rem; color:#475569;">üë¥üëµ AV√ìS</h3>
                        <div style="display:grid; grid-template-columns:repeat(4, 1fr); gap:1rem; max-width:1200px; margin:0 auto;">
                            <div style="padding:1rem; background:#e0f2fe; border-radius:0.8rem; border:2px solid #7dd3fc;">
                                <div style="font-size:0.8rem; font-weight:700; color:#0369a1; margin-bottom:0.5rem;">Av√¥ Paterno</div>
                                <div style="font-size:0.85rem; color:#1e293b;">${avoPaterno.texto}</div>
                            </div>
                            <div style="padding:1rem; background:#fce7f3; border-radius:0.8rem; border:2px solid #f9a8d4;">
                                <div style="font-size:0.8rem; font-weight:700; color:#be185d; margin-bottom:0.5rem;">Av√≥ Paterna</div>
                                <div style="font-size:0.85rem; color:#1e293b;">${avoaPaterna.texto}</div>
                            </div>
                            <div style="padding:1rem; background:#e0f2fe; border-radius:0.8rem; border:2px solid #7dd3fc;">
                                <div style="font-size:0.8rem; font-weight:700; color:#0369a1; margin-bottom:0.5rem;">Av√¥ Materno</div>
                                <div style="font-size:0.85rem; color:#1e293b;">${avoMaterno.texto}</div>
                            </div>
                            <div style="padding:1rem; background:#fce7f3; border-radius:0.8rem; border:2px solid #f9a8d4;">
                                <div style="font-size:0.8rem; font-weight:700; color:#be185d; margin-bottom:0.5rem;">Av√≥ Materna</div>
                                <div style="font-size:0.85rem; color:#1e293b;">${avoaMaterna.texto}</div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top:2rem; padding:1rem; background:#fef3c7; border-radius:0.8rem; max-width:1200px; margin:2rem auto 0;">
                        <div style="font-size:0.85rem; color:#92400e;">
                            üí° <strong>Observa√ß√£o:</strong> Para visualizar bisav√≥s, cadastre os pais dos av√≥s na ficha de cada animal correspondente.
                        </div>
                    </div>
                </div>
            `;
        }

        function exportarExcel() {
            if (animais.length === 0) return alert('‚ö†Ô∏è Sem dados!');
            const ordenados = ordenarAnimaisPorNumero(animais);
            
            const dadosExcel = ordenados.map(a => {
                let paiTexto = '-';
                if (a.pai) {
                    if (a.pai.startsWith('reprodutor_')) {
                        const reprodutorId = a.pai.replace('reprodutor_', '');
                        const reprodutor = reprodutores.find(x => x.id === reprodutorId);
                        if (reprodutor) {
                            paiTexto = `${reprodutor.registro} - ${reprodutor.nome} (Reprodutor)`;
                        }
                    } else {
                        const pai = animais.find(x => x.id === a.pai);
                        if (pai) {
                            paiTexto = `${pai.numero} - ${pai.nome || 'Sem nome'}`;
                        }
                    }
                }
                
                const mae = a.mae ? animais.find(x => x.id === a.mae) : null;
                
                return {
                    'N√∫mero': a.numero,
                    'Brinco': a.brinco || '-',
                    'Nome': a.nome || '-',
                    'Sexo': a.sexo === 'F' ? 'F√™mea' : 'Macho',
                    'Ra√ßa': a.raca,
                    'Local': a.local,
                    'Propriet√°rio': a.proprietario,
                    'Nascimento': a.dataNascimento || '-',
                    'Pai': paiTexto,
                    'M√£e': mae ? `${mae.numero} - ${mae.nome || 'Sem nome'}` : '-',
                    'Sem Ferro': a.semFerro ? 'Sim' : 'N√£o',
                    'Amamentando': a.amamentando ? 'Sim' : 'N√£o'
                };
            });
            
            const ws = XLSX.utils.json_to_sheet(dadosExcel);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Rebanho");
            XLSX.writeFile(wb, "Rebanho_" + Date.now() + ".xlsx");
            alert("‚úÖ Excel exportado!");
        }

        // ===================== FUN√á√ïES REPRODUTORES =====================

        function atualizarSelectsReprodutores() {
            document.getElementById('racaReprodutor').innerHTML = racas.map(r => `<option value="${r}">${r}</option>`).join('');
            document.getElementById('propReprodutor').innerHTML = proprietarios.map(p => `<option value="${p}">${p}</option>`).join('');
            document.getElementById('localReprodutor').innerHTML = locais.map(l => `<option value="${l}">${l}</option>`).join('');
        }

        async function salvarReprodutor(e) {
            e.preventDefault();
            
            const registro = document.getElementById('regReprodutor').value.trim();
            
            const registroJaExiste = reprodutores.some(r => 
                r.registro === registro && r.id !== reprodutorAtualId
            );
            
            if (registroJaExiste) {
                alert('‚ö†Ô∏è Este registro j√° est√° cadastrado!');
                return;
            }
            
            const reprodutor = {
                id: reprodutorAtualId || Date.now().toString(),
                registro: registro,
                nome: document.getElementById('nomeReprodutor').value.trim(),
                raca: document.getElementById('racaReprodutor').value,
                tipo: document.getElementById('tipoReprodutor').value,
                proprietario: document.getElementById('propReprodutor').value,
                local: document.getElementById('localReprodutor').value,
                origem: document.getElementById('origemReprodutor').value.trim(),
                dataNascimento: document.getElementById('nascReprodutor').value,
                status: document.getElementById('statusReprodutor').value,
                observacoes: document.getElementById('obsReprodutor').value.trim(),
                foto: fotoAtualReprodutor || ''
            };

            if (reprodutorAtualId) {
                const idx = reprodutores.findIndex(r => r.id === reprodutorAtualId);
                if (idx !== -1) {
                    reprodutores[idx] = reprodutor;
                }
            } else {
                reprodutores.push(reprodutor);
            }

            await salvarDadosOnline();
            renderizarTabelaReprodutores();
            atualizarSelects();
            limparFormReprodutor();
            alert("‚úÖ Reprodutor salvo com sucesso!");
        }

        function limparFormReprodutor() {
            reprodutorAtualId = null;
            document.getElementById('reprodutorForm').reset();
            removerFotoReprodutor();
        }

        function renderizarTabelaReprodutores(data = reprodutores) {
            const tbody = document.getElementById('tabelaReprodutores');
            
            const ordenados = [...data].sort((a, b) => a.registro.localeCompare(b.registro));
            
            if (ordenados.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #94a3b8; padding: 2rem;">Nenhum reprodutor cadastrado</td></tr>';
            } else {
                tbody.innerHTML = ordenados.map(r => {
                    const statusBadge = r.status === 'Ativo' 
                        ? '<span class="badge" style="background: #d1fae5; color: #065f46;">‚úì Ativo</span>'
                        : r.status === 'Inativo'
                        ? '<span class="badge" style="background: #fed7aa; color: #c2410c;">‚è∏ Inativo</span>'
                        : '<span class="badge" style="background: #fecaca; color: #991b1b;">‚úó Descartado</span>';
                    
                    const tipoBadge = r.tipo === 'Touro'
                        ? '<span class="badge badge-blue">üêÇ Touro</span>'
                        : '<span class="badge badge-pink">üíâ S√™men</span>';
                    
                    const fotoHTML = r.foto 
                        ? `<img src="${r.foto}" style="width: 40px; height: 40px; border-radius: 0.5rem; object-fit: cover; cursor: pointer;" onclick="event.stopPropagation(); ampliarFotoTabela('${r.foto}')">`
                        : '<div style="width: 40px; height: 40px; background: #f1f5f9; border-radius: 0.5rem; display: flex; align-items: center; justify-content: center; font-size: 1.2rem;">üì∑</div>';
                    
                    return `
                        <tr onclick="selecionarReprodutor('${r.id}')">
                            <td>${fotoHTML}</td>
                            <td><strong>${r.registro}</strong></td>
                            <td>${r.nome}</td>
                            <td>${r.raca}</td>
                            <td>${tipoBadge}</td>
                            <td>${r.local}</td>
                            <td>${statusBadge}</td>
                        </tr>
                    `;
                }).join('');
            }
            
            // Atualizar estat√≠sticas
            document.getElementById('totalReprodutores').innerText = reprodutores.length;
            document.getElementById('reprodutoresAtivos').innerText = reprodutores.filter(r => r.status === 'Ativo').length;
            document.getElementById('reprodutoresTouros').innerText = reprodutores.filter(r => r.tipo === 'Touro').length;
            document.getElementById('reprodutoresSemen').innerText = reprodutores.filter(r => r.tipo === 'S√™men').length;
        }

        function selecionarReprodutor(id) {
            const r = reprodutores.find(x => x.id === id);
            if (!r) return;
            
            // Trocar para aba de reprodutores se n√£o estiver nela
            const tabReprodutor = document.getElementById('tab-reprodutores');
            if (tabReprodutor.classList.contains('hidden')) {
                document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden'));
                document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                tabReprodutor.classList.remove('hidden');
                document.querySelector('[onclick="showTab(\'reprodutores\')"]').classList.add('active');
            }
            
            reprodutorAtualId = id;
            document.getElementById('regReprodutor').value = r.registro;
            document.getElementById('nomeReprodutor').value = r.nome;
            document.getElementById('racaReprodutor').value = r.raca;
            document.getElementById('tipoReprodutor').value = r.tipo;
            document.getElementById('propReprodutor').value = r.proprietario;
            document.getElementById('localReprodutor').value = r.local;
            document.getElementById('origemReprodutor').value = r.origem || '';
            document.getElementById('nascReprodutor').value = r.dataNascimento || '';
            document.getElementById('statusReprodutor').value = r.status;
            document.getElementById('obsReprodutor').value = r.observacoes || '';
            
            // Carregar foto
            if (r.foto) {
                fotoAtualReprodutor = r.foto;
                document.getElementById('fotoPreviewReprodutor').src = r.foto;
                document.getElementById('fotoContainerReprodutor').style.display = 'block';
            } else {
                removerFotoReprodutor();
            }
        }

        async function excluirReprodutor() {
            if (!reprodutorAtualId) {
                alert("‚ö†Ô∏è Selecione um reprodutor!");
                return;
            }
            if (confirm("üóëÔ∏è Excluir este reprodutor?")) {
                reprodutores = reprodutores.filter(r => r.id !== reprodutorAtualId);
                await salvarDadosOnline();
                renderizarTabelaReprodutores();
                atualizarSelects();
                limparFormReprodutor();
            }
        }

        function pesquisarReprodutores(val) {
            const filtrados = reprodutores.filter(r =>
                r.registro.toLowerCase().includes(val.toLowerCase()) ||
                r.nome.toLowerCase().includes(val.toLowerCase()) ||
                r.raca.toLowerCase().includes(val.toLowerCase()) ||
                r.tipo.toLowerCase().includes(val.toLowerCase())
            );
            renderizarTabelaReprodutores(filtrados);
        }

        function exportarReprodutoresExcel() {
            if (reprodutores.length === 0) return alert('‚ö†Ô∏è Sem dados!');
            
            const ordenados = [...reprodutores].sort((a, b) => a.registro.localeCompare(b.registro));
            
            const dadosExcel = ordenados.map(r => ({
                'Registro': r.registro,
                'Nome': r.nome,
                'Ra√ßa': r.raca,
                'Tipo': r.tipo,
                'Propriet√°rio': r.proprietario,
                'Local/Pasto': r.local,
                'Origem/Central': r.origem || '-',
                'Nascimento': r.dataNascimento || '-',
                'Status': r.status,
                'Observa√ß√µes': r.observacoes || '-'
            }));
            
            const ws = XLSX.utils.json_to_sheet(dadosExcel);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Reprodutores");
            XLSX.writeFile(wb, "Reprodutores_" + Date.now() + ".xlsx");
            alert("‚úÖ Excel exportado!");
        }
    </script>
</body>
</html>

