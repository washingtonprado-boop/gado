<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SisGado Pro - Sistema Premium</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, set, get, remove } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';
        
        const firebaseConfig = {
            apiKey: "AIzaSyC7SscZZ2uhic2JXaQYfmnvh5mRgwpk0y8",
            authDomain: "gado-5821a.firebaseapp.com",
            databaseURL: "https://gado-5821a-default-rtdb.firebaseio.com",
            projectId: "gado-5821a",
            storageBucket: "gado-5821a.firebasestorage.app",
            messagingSenderId: "1065455551718",
            appId: "1:1065455551718:web:9e20cc6e84dc76e0ae6727",
            measurementId: "G-Q98K1CMBK3"
        };
        
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        
        window.firebaseDB = { database, ref, set, get, remove };
    </script>
    
    <style>
        * {margin: 0; padding: 0; box-sizing: border-box;}
        body {font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh;}
        .app-container {background: #f8fafc; min-height: 100vh;}
        .header {background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); color: white; padding: 2.5rem; box-shadow: 0 10px 40px rgba(0,0,0,0.3); position: relative; border-bottom: 3px solid #3b82f6;}
        .header h1 {font-size: 2.5rem; font-weight: 800; margin-bottom: 0.5rem;}
        .sync-status {position: absolute; top: 2rem; right: 2rem; background: rgba(59, 130, 246, 0.2); padding: 0.7rem 1.5rem; border-radius: 2rem; font-size: 0.875rem; border: 1px solid rgba(59, 130, 246, 0.3); cursor: pointer;}
        .sync-status.online {background: rgba(34, 197, 94, 0.2); border-color: rgba(34, 197, 94, 0.3);}
        .nav-tabs {background: white; border-bottom: 2px solid #e2e8f0; padding: 0 2rem; display: flex; gap: 0.5rem; overflow-x: auto; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 10px rgba(0,0,0,0.05);}
        .nav-tab {padding: 1.2rem 1.5rem; border: none; background: none; cursor: pointer; font-size: 0.9rem; font-weight: 600; color: #64748b; border-bottom: 3px solid transparent; transition: all 0.3s; white-space: nowrap;}
        .nav-tab:hover {color: #3b82f6; transform: translateY(-2px);}
        .nav-tab.active {color: #3b82f6; border-bottom-color: #3b82f6; background: linear-gradient(180deg, transparent 0%, rgba(59, 130, 246, 0.05) 100%);}
        .container {max-width: 1600px; margin: 0 auto; padding: 2rem;}
        .main-grid {display: grid; grid-template-columns: 420px 1fr; gap: 2rem;}
        .card {background: white; border-radius: 1.2rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); padding: 2rem; margin-bottom: 2rem; border: 1px solid rgba(0,0,0,0.05); transition: all 0.3s;}
        .card:hover {box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);}
        .card h2, .card h3 {margin-bottom: 1.5rem; color: #1e293b; font-weight: 700;}
        .form-group {margin-bottom: 1.2rem;}
        .form-group label {display: block; font-size: 0.8rem; font-weight: 700; color: #475569; text-transform: uppercase; margin-bottom: 0.5rem; letter-spacing: 0.5px;}
        .form-group input, .form-group select, .form-group textarea {width: 100%; padding: 0.8rem 1rem; border: 2px solid #e2e8f0; border-radius: 0.7rem; font-size: 0.95rem; transition: all 0.3s; background: #f8fafc;}
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {outline: none; border-color: #3b82f6; background: white; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);}
        .btn {padding: 0.8rem 1.5rem; border: none; border-radius: 0.7rem; font-weight: 600; cursor: pointer; transition: all 0.3s; display: inline-flex; align-items: center; justify-content: center; gap: 0.6rem; font-size: 0.95rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1);}
        .btn:hover {transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.15);}
        .btn-primary {background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white;}
        .btn-success {background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); color: white;}
        .btn-danger {background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white;}
        .btn-warning {background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white;}
        .btn-secondary {background: linear-gradient(135deg, #64748b 0%, #475569 100%); color: white;}
        .grid-2 {display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;}
        .checkbox-group {display: flex; gap: 1.5rem; margin: 1rem 0; padding: 1.2rem; background: linear-gradient(135deg, #f8fafc 0%, #e0f2fe 100%); border-radius: 0.7rem; border: 2px dashed #cbd5e1;}
        .checkbox-group label {display: flex; align-items: center; gap: 0.5rem; cursor: pointer; font-weight: 500;}
        table {width: 100%; border-collapse: collapse;}
        th {background: linear-gradient(135deg, #f8fafc 0%, #e0f2fe 100%); padding: 1.2rem; text-align: left; font-size: 0.75rem; color: #475569; border-bottom: 2px solid #cbd5e1; font-weight: 700; text-transform: uppercase;}
        td {padding: 1.2rem; border-bottom: 1px solid #f1f5f9; font-size: 0.9rem;}
        tr:hover {background: linear-gradient(90deg, #f1f5f9 0%, #e0f2fe 100%); cursor: pointer;}
        .hidden {display: none;}
        .stats-grid {display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;}
        .stat-card {background: linear-gradient(135deg, white 0%, #f8fafc 100%); padding: 2rem; border-radius: 1.2rem; text-align: center; border-bottom: 4px solid #3b82f6; box-shadow: 0 4px 6px rgba(0,0,0,0.07); transition: all 0.3s;}
        .stat-card:hover {transform: translateY(-5px); box-shadow: 0 12px 24px rgba(0,0,0,0.12);}
        .badge {padding: 0.3rem 0.8rem; border-radius: 1rem; font-size: 0.75rem; font-weight: 600; display: inline-block;}
        .badge-blue {background: #dbeafe; color: #1e40af;}
        .badge-pink {background: #fce7f3; color: #be185d;}
        .item-box {display: flex; justify-content: space-between; align-items: center; padding: 1rem 1.2rem; background: linear-gradient(135deg, #f8fafc 0%, white 100%); border-radius: 0.7rem; margin-bottom: 0.7rem; border: 2px solid #e2e8f0; transition: all 0.3s; cursor: pointer;}
        .item-box:hover {border-color: #3b82f6; transform: translateX(5px);}
        @media print {.nav-tabs, .sync-status, .btn {display: none !important;}}
        @media (max-width: 768px) {.main-grid, .grid-2 {grid-template-columns: 1fr;}}
    </style>
</head>
<body>
    <div class="app-container">
        <div class="header">
            <h1>üêÑ SisGado Pro</h1>
            <p>Gest√£o Pecu√°ria Inteligente 2026</p>
            <div class="sync-status" id="syncStatus" onclick="sincronizarDados()">
                <span id="syncText">üîÑ Sincronizar</span>
            </div>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('animals')">üêÆ Rebanho</button>
            <button class="nav-tab" onclick="showTab('reports')">üìä Dashboard</button>
            <button class="nav-tab" onclick="showTab('relatorios')">üìÑ Relat√≥rios</button>
            <button class="nav-tab" onclick="showTab('genealogy')">üå≥ Genealogia</button>
            <button class="nav-tab" onclick="showTab('racas')">üè∑Ô∏è Ra√ßas/Locais</button>
            <button class="nav-tab" onclick="showTab('owners')">üë• Propriet√°rios</button>
        </div>

        <div class="container">
            <!-- TAB REBANHO -->
            <div id="tab-animals" class="tab-content">
                <div class="main-grid">
                    <div class="card">
                        <h2>üìã Cadastro de Animal</h2>
                        <form id="animalForm" onsubmit="salvarAnimal(event)">
                            <div class="form-group">
                                <label>N√∫mero/ID</label>
                                <div style="display:flex; gap:8px">
                                    <input type="text" id="numero" required style="flex: 1;">
                                    <button type="button" class="btn btn-secondary" onclick="gerarNumero()" style="padding: 0.8rem 1rem;">üî¢</button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; text-transform: none;">
                                    <input type="checkbox" id="temBrinco" onchange="toggleBrinco()" style="width: auto;">
                                    Possui Brinco
                                </label>
                                <input type="text" id="brinco" placeholder="N√∫mero do brinco" style="display: none; margin-top: 0.5rem;">
                            </div>
                            <div class="form-group">
                                <label>Nome</label>
                                <input type="text" id="nome">
                            </div>
                            <div class="grid-2">
                                <div class="form-group">
                                    <label>Sexo</label>
                                    <select id="sexo">
                                        <option value="F">F√™mea</option>
                                        <option value="M">Macho</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Ra√ßa</label>
                                    <select id="raca"></select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Local/Pasto</label>
                                <select id="local"></select>
                            </div>
                            <div class="form-group">
                                <label>Propriet√°rio</label>
                                <select id="proprietario"></select>
                            </div>
                            <div class="form-group">
                                <label>Nascimento</label>
                                <input type="date" id="dataNascimento">
                            </div>
                            <div class="grid-2">
                                <div class="form-group">
                                    <label>Pai</label>
                                    <input type="text" id="pai" placeholder="Nome/N√∫mero">
                                </div>
                                <div class="form-group">
                                    <label>M√£e</label>
                                    <input type="text" id="mae" placeholder="Nome/N√∫mero">
                                </div>
                            </div>
                            <div class="checkbox-group">
                                <label><input type="checkbox" id="semFerro"> Sem Ferro</label>
                                <label><input type="checkbox" id="amamentando"> Amamentando</label>
                            </div>
                            <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                <button type="submit" class="btn btn-primary">üíæ Salvar</button>
                                <button type="button" class="btn btn-warning" onclick="limparForm()">üîÑ Novo</button>
                            </div>
                            <button type="button" class="btn btn-danger" onclick="excluirAnimal()" style="width: 100%; margin-top: 10px;">üóëÔ∏è Excluir</button>
                        </form>
                    </div>

                    <div class="card">
                        <div style="display:flex; justify-content: space-between; margin-bottom: 1.5rem; gap: 1rem; flex-wrap: wrap;">
                            <input type="text" id="campoPesquisa" placeholder="üîç Pesquisar..." style="flex: 1; min-width: 200px; padding: 0.8rem; border: 2px solid #e2e8f0; border-radius: 0.7rem;" onkeyup="pesquisarAnimais(this.value)">
                            <button class="btn btn-success" onclick="exportarExcel()">üìä Excel</button>
                        </div>
                        <div style="overflow-x: auto;">
                            <table>
                                <thead>
                                    <tr>
                                        <th>üî¢ ID</th>
                                        <th>üìù Nome</th>
                                        <th>‚ö• Sexo</th>
                                        <th>üêÑ Ra√ßa</th>
                                        <th>üìç Local</th>
                                        <th>üéÇ Idade</th>
                                    </tr>
                                </thead>
                                <tbody id="tabelaAnimais"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TAB DASHBOARD -->
            <div id="tab-reports" class="tab-content hidden">
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>üêÆ Total</h3>
                        <div id="totalAnimais" style="font-size: 3rem; font-weight: 800;">0</div>
                    </div>
                    <div class="stat-card" style="border-bottom-color: #ec4899;">
                        <h3>‚ôÄ F√™meas</h3>
                        <div id="totalFemeas" style="font-size: 3rem; font-weight: 800; color: #ec4899;">0</div>
                    </div>
                    <div class="stat-card" style="border-bottom-color: #3b82f6;">
                        <h3>‚ôÇ Machos</h3>
                        <div id="totalMachos" style="font-size: 3rem; font-weight: 800; color: #3b82f6;">0</div>
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(450px, 1fr)); gap: 2rem;">
                    <div class="card"><canvas id="racaChart"></canvas></div>
                    <div class="card"><canvas id="localChart"></canvas></div>
                </div>
            </div>

            <!-- TAB RELAT√ìRIOS -->
            <div id="tab-relatorios" class="tab-content hidden">
                <div class="card">
                    <h2>üìÑ Relat√≥rios Gerenciais</h2>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5rem;">
                        <div class="item-box" onclick="gerarRelatorioCompleto()" style="background: linear-gradient(135deg, #dbeafe, #bfdbfe);">
                            <div>
                                <div style="font-size: 1.2rem; font-weight: 700;">üìã Completo</div>
                                <div style="color: #64748b; font-size: 0.9rem;">Todos os animais</div>
                            </div>
                            <div style="font-size: 2rem;">üìä</div>
                        </div>
                        <div class="item-box" onclick="gerarRelatorioPorRaca()" style="background: linear-gradient(135deg, #fce7f3, #fbcfe8);">
                            <div>
                                <div style="font-size: 1.2rem; font-weight: 700;">üêÑ Por Ra√ßa</div>
                                <div style="color: #64748b; font-size: 0.9rem;">Agrupado</div>
                            </div>
                            <div style="font-size: 2rem;">üè∑Ô∏è</div>
                        </div>
                        <div class="item-box" onclick="gerarRelatorioFemeas()" style="background: linear-gradient(135deg, #fef3c7, #fde68a);">
                            <div>
                                <div style="font-size: 1.2rem; font-weight: 700;">‚ôÄ F√™meas</div>
                                <div style="color: #64748b; font-size: 0.9rem;">Matrizes</div>
                            </div>
                            <div style="font-size: 2rem;">üêÆ</div>
                        </div>
                        <div class="item-box" onclick="gerarRelatorioPorProprietario()" style="background: linear-gradient(135deg, #e0e7ff, #c7d2fe);">
                            <div>
                                <div style="font-size: 1.2rem; font-weight: 700;">üë• Propriet√°rios</div>
                                <div style="color: #64748b; font-size: 0.9rem;">Por dono</div>
                            </div>
                            <div style="font-size: 2rem;">üë§</div>
                        </div>
                        <div class="item-box" onclick="gerarRelatorioAmamentando()" style="background: linear-gradient(135deg, #fce7f3, #fbcfe8);">
                            <div>
                                <div style="font-size: 1.2rem; font-weight: 700;">üçº Amamentando</div>
                                <div style="color: #64748b; font-size: 0.9rem;">F√™meas lactantes</div>
                            </div>
                            <div style="font-size: 2rem;">üë∂</div>
                        </div>
                        <div class="item-box" onclick="gerarRelatorioSemFerro()" style="background: linear-gradient(135deg, #fed7aa, #fdba74);">
                            <div>
                                <div style="font-size: 1.2rem; font-weight: 700;">üîì Sem Ferro</div>
                                <div style="color: #64748b; font-size: 0.9rem;">N√£o marcados</div>
                            </div>
                            <div style="font-size: 2rem;">üö´</div>
                        </div>
                    </div>
                    <div id="previewRelatorio" style="margin-top: 2rem; display: none;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 1rem;">
                            <h3 id="tituloRelatorio"></h3>
                            <button class="btn btn-warning" onclick="fecharRelatorio()">‚úñÔ∏è Fechar</button>
                        </div>
                        <div id="conteudoRelatorio" style="padding: 2rem; background: #f8fafc; border-radius: 1rem;"></div>
                    </div>
                </div>
            </div>

            <!-- TAB GENEALOGIA -->
            <div id="tab-genealogy" class="tab-content hidden">
                <div class="card">
                    <h2>üå≥ √Årvore Geneal√≥gica</h2>
                    <select id="animalGenealogia" onchange="mostrarGenealogia()" style="padding:1rem; width:100%; margin-bottom: 1.5rem; border: 2px solid #e2e8f0; border-radius: 0.7rem;"></select>
                    <div id="arvoreGenealogia" style="padding: 2rem; background: #f8fafc; border-radius: 1rem; min-height: 300px;"></div>
                </div>
            </div>

            <!-- TAB RA√áAS/LOCAIS -->
            <div id="tab-racas" class="tab-content hidden">
                <div class="grid-2">
                    <div class="card">
                        <h2>üè∑Ô∏è Ra√ßas</h2>
                        <div class="form-group">
                            <input type="text" id="novaRaca" placeholder="Nome da Ra√ßa">
                        </div>
                        <button class="btn btn-primary" onclick="adicionarRaca()">‚ûï Adicionar</button>
                        <div id="listaRacas" style="margin-top: 1.5rem;"></div>
                    </div>
                    <div class="card">
                        <h2>üìç Pastos</h2>
                        <div class="form-group">
                            <input type="text" id="novoLocal" placeholder="Nome do Pasto">
                        </div>
                        <button class="btn btn-primary" onclick="adicionarLocal()">‚ûï Adicionar</button>
                        <div id="listaLocais" style="margin-top: 1.5rem;"></div>
                    </div>
                </div>
            </div>

            <!-- TAB PROPRIET√ÅRIOS -->
            <div id="tab-owners" class="tab-content hidden">
                <div class="card">
                    <h2>üë• Gerenciar Propriet√°rios</h2>
                    <div class="form-group">
                        <input type="text" id="novoProprietario" placeholder="Nome do Propriet√°rio">
                    </div>
                    <button class="btn btn-primary" onclick="adicionarProprietario()">‚ûï Adicionar Propriet√°rio</button>
                    <div id="listaProprietarios" style="margin-top: 1.5rem;"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let animais = [];
        let racas = ['NELORE', 'ANGUS', 'BRAHMAN', 'GIROLAND'];
        let locais = ['PASTO 01', 'PASTO 02', 'CURRAL'];
        let proprietarios = ['FAZENDA PR√ìPRIA'];
        let animalAtualId = null;
        let charts = {};

        window.onload = async () => {
            setTimeout(async () => {
                await carregarDados();
                renderizarTabela();
                atualizarSelects();
                renderListas();
            }, 500);
        };

        async function carregarDados() {
            if (!window.firebaseDB) return;
            const { database, ref, get } = window.firebaseDB;
            
            try {
                const snapshot = await get(ref(database, 'animais'));
                if (snapshot.exists()) {
                    animais = Object.values(snapshot.val());
                    atualizarStatusSync(true);
                }
            } catch (e) {
                console.log('Erro ao carregar animais:', e);
            }

            try {
                const racasSnap = await get(ref(database, 'racas'));
                if (racasSnap.exists()) racas = racasSnap.val();
            } catch (e) {}

            try {
                const locaisSnap = await get(ref(database, 'locais'));
                if (locaisSnap.exists()) locais = locaisSnap.val();
            } catch (e) {}

            try {
                const propsSnap = await get(ref(database, 'proprietarios'));
                if (propsSnap.exists()) proprietarios = propsSnap.val();
            } catch (e) {}
        }

        async function salvarDadosOnline() {
            if (!window.firebaseDB) return false;
            const { database, ref, set } = window.firebaseDB;
            
            try {
                const animaisObj = {};
                animais.forEach(a => { animaisObj[a.id] = a; });
                
                await set(ref(database, 'animais'), animaisObj);
                await set(ref(database, 'racas'), racas);
                await set(ref(database, 'locais'), locais);
                await set(ref(database, 'proprietarios'), proprietarios);
                
                atualizarStatusSync(true);
                return true;
            } catch (e) {
                console.error('Erro ao salvar:', e);
                return false;
            }
        }

        async function sincronizarDados() {
            const btn = document.getElementById('syncStatus');
            const txt = document.getElementById('syncText');
            btn.style.pointerEvents = 'none';
            txt.innerText = '‚è≥ Sincronizando...';

            const ok = await salvarDadosOnline();

            btn.style.pointerEvents = 'auto';
            if (ok) {
                alert('‚úÖ Dados sincronizados!');
            } else {
                txt.innerText = 'üîÑ Sincronizar';
                alert('‚ùå Erro ao sincronizar!');
            }
        }

        function atualizarStatusSync(online) {
            const status = document.getElementById('syncStatus');
            const text = document.getElementById('syncText');
            if (online) {
                status.classList.add('online');
                text.innerText = '‚òÅÔ∏è Online';
            } else {
                status.classList.remove('online');
                text.innerText = 'üîÑ Sincronizar';
            }
        }

        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden'));
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.getElementById('tab-' + tabName).classList.remove('hidden');
            event.currentTarget.classList.add('active');
            if (tabName === 'reports') atualizarDashboard();
        }

        async function salvarAnimal(e) {
            e.preventDefault();
            
            const numero = document.getElementById('numero').value.trim();
            
            const numeroJaExiste = animais.some(a => 
                a.numero === numero && a.id !== animalAtualId
            );
            
            if (numeroJaExiste) {
                alert('‚ö†Ô∏è Este n√∫mero j√° est√° cadastrado!');
                return;
            }
            
            const animal = {
                id: animalAtualId || Date.now().toString(),
                numero: numero,
                brinco: document.getElementById('temBrinco').checked ? document.getElementById('brinco').value : '',
                nome: document.getElementById('nome').value,
                sexo: document.getElementById('sexo').value,
                raca: document.getElementById('raca').value,
                local: document.getElementById('local').value,
                proprietario: document.getElementById('proprietario').value,
                dataNascimento: document.getElementById('dataNascimento').value,
                pai: document.getElementById('pai').value,
                mae: document.getElementById('mae').value,
                semFerro: document.getElementById('semFerro').checked,
                amamentando: document.getElementById('amamentando').checked
            };

            if (animalAtualId) {
                const idx = animais.findIndex(a => a.id === animalAtualId);
                if (idx !== -1) {
                    animais[idx] = animal;
                }
            } else {
                animais.push(animal);
            }

            await salvarDadosOnline();
            renderizarTabela();
            atualizarSelects();
            limparForm();
            alert("‚úÖ Animal salvo com sucesso!");
        }

        async function excluirAnimal() {
            if (!animalAtualId) {
                alert("‚ö†Ô∏è Selecione um animal!");
                return;
            }
            if (confirm("üóëÔ∏è Excluir este animal?")) {
                animais = animais.filter(a => a.id !== animalAtualId);
                await salvarDadosOnline();
                renderizarTabela();
                limparForm();
            }
        }

        function selecionarAnimal(id) {
            const a = animais.find(x => x.id === id);
            if (!a) return;
            
            animalAtualId = id;
            document.getElementById('numero').value = a.numero;
            
            if (a.brinco) {
                document.getElementById('temBrinco').checked = true;
                document.getElementById('brinco').style.display = 'block';
                document.getElementById('brinco').value = a.brinco;
            } else {
                document.getElementById('temBrinco').checked = false;
                document.getElementById('brinco').style.display = 'none';
                document.getElementById('brinco').value = '';
            }
            
            document.getElementById('nome').value = a.nome || '';
            document.getElementById('sexo').value = a.sexo;
            document.getElementById('raca').value = a.raca;
            document.getElementById('local').value = a.local;
            document.getElementById('proprietario').value = a.proprietario || '';
            document.getElementById('dataNascimento').value = a.dataNascimento || '';
            document.getElementById('pai').value = a.pai || '';
            document.getElementById('mae').value = a.mae || '';
            document.getElementById('semFerro').checked = a.semFerro || false;
            document.getElementById('amamentando').checked = a.amamentando || false;
        }

        function limparForm() {
            animalAtualId = null;
            document.getElementById('animalForm').reset();
            document.getElementById('temBrinco').checked = false;
            document.getElementById('brinco').style.display = 'none';
        }

        function toggleBrinco() {
            const campo = document.getElementById('brinco');
            campo.style.display = document.getElementById('temBrinco').checked ? 'block' : 'none';
        }

        function gerarNumero() {
            const max = animais.length > 0 ? Math.max(...animais.map(a => parseInt(a.numero) || 0)) : 0;
            document.getElementById('numero').value = (max + 1).toString().padStart(2, '0');
        }

        function renderizarTabela(data = animais) {
            const tbody = document.getElementById('tabelaAnimais');
            
            const ordenados = [...data].sort((a, b) => {
                const numA = parseInt(a.numero) || 0;
                const numB = parseInt(b.numero) || 0;
                return numA - numB;
            });
            
            if (ordenados.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #94a3b8; padding: 2rem;">Nenhum animal cadastrado</td></tr>';
                return;
            }
            
            tbody.innerHTML = ordenados.map(a => {
                const idade = calcularIdade(a.dataNascimento);
                const sexoBadge = a.sexo === 'F' ? '<span class="badge badge-pink">‚ôÄ</span>' : '<span class="badge badge-blue">‚ôÇ</span>';
                return `
                    <tr onclick="selecionarAnimal('${a.id}')">
                        <td><strong>${a.numero}</strong></td>
                        <td>${a.nome || '-'}</td>
                        <td>${sexoBadge}</td>
                        <td>${a.raca}</td>
                        <td>${a.local}</td>
                        <td>${idade}</td>
                    </tr>
                `;
            }).join('');
        }

        function calcularIdade(dataNasc) {
            if (!dataNasc) return '-';
            const hoje = new Date();
            const nasc = new Date(dataNasc);
            const diffDays = Math.ceil((hoje - nasc) / (1000 * 60 * 60 * 24));
            if (diffDays < 30) return `${diffDays}d`;
            if (diffDays < 365) return `${Math.floor(diffDays / 30)}m`;
            const anos = Math.floor(diffDays / 365);
            const meses = Math.floor((diffDays % 365) / 30);
            return meses > 0 ? `${anos}a ${meses}m` : `${anos}a`;
        }

        function pesquisarAnimais(val) {
            const filtrados = animais.filter(a =>
                a.numero.toLowerCase().includes(val.toLowerCase()) ||
                (a.nome && a.nome.toLowerCase().includes(val.toLowerCase())) ||
                (a.raca && a.raca.toLowerCase().includes(val.toLowerCase()))
            );
            renderizarTabela(filtrados);
        }

        function atualizarSelects() {
            document.getElementById('raca').innerHTML = racas.map(r => `<option value="${r}">${r}</option>`).join('');
            document.getElementById('local').innerHTML = locais.map(l => `<option value="${l}">${l}</option>`).join('');
            document.getElementById('proprietario').innerHTML = proprietarios.map(p => `<option value="${p}">${p}</option>`).join('');
            document.getElementById('animalGenealogia').innerHTML = '<option value="">Selecione...</option>' + animais.map(a => `<option value="${a.id}">${a.numero} - ${a.nome || 'Sem nome'}</option>`).join('');
        }

        async function adicionarRaca() {
            const val = document.getElementById('novaRaca').value.toUpperCase().trim();
            if (!val) return alert('‚ö†Ô∏è Digite o nome!');
            if (racas.includes(val)) return alert('‚ö†Ô∏è J√° existe!');
            racas.push(val);
            await salvarDadosOnline();
            document.getElementById('novaRaca').value = '';
            renderListas();
            atualizarSelects();
        }

        async function adicionarLocal() {
            const val = document.getElementById('novoLocal').value.toUpperCase().trim();
            if (!val) return alert('‚ö†Ô∏è Digite o nome!');
            if (locais.includes(val)) return alert('‚ö†Ô∏è J√° existe!');
            locais.push(val);
            await salvarDadosOnline();
            document.getElementById('novoLocal').value = '';
            renderListas();
            atualizarSelects();
        }

        async function adicionarProprietario() {
            const val = document.getElementById('novoProprietario').value.toUpperCase().trim();
            if (!val) return alert('‚ö†Ô∏è Digite o nome!');
            if (proprietarios.includes(val)) return alert('‚ö†Ô∏è J√° existe!');
            proprietarios.push(val);
            await salvarDadosOnline();
            document.getElementById('novoProprietario').value = '';
            renderListas();
            atualizarSelects();
        }

        function renderListas() {
            document.getElementById('listaRacas').innerHTML = racas.map(r => `<div class="item-box"><span>${r}</span></div>`).join('');
            document.getElementById('listaLocais').innerHTML = locais.map(l => `<div class="item-box"><span>${l}</span></div>`).join('');
            document.getElementById('listaProprietarios').innerHTML = proprietarios.map(p => `<div class="item-box"><span>${p}</span></div>`).join('');
        }

        function atualizarDashboard() {
            document.getElementById('totalAnimais').innerText = animais.length;
            document.getElementById('totalFemeas').innerText = animais.filter(a => a.sexo === 'F').length;
            document.getElementById('totalMachos').innerText = animais.filter(a => a.sexo === 'M').length;

            if (charts.racaChart) charts.racaChart.destroy();
            if (charts.localChart) charts.localChart.destroy();

            const racaCounts = animais.reduce((acc, a) => {
                acc[a.raca] = (acc[a.raca] || 0) + 1;
                return acc;
            }, {});
            const localCounts = animais.reduce((acc, a) => {
                acc[a.local] = (acc[a.local] || 0) + 1;
                return acc;
            }, {});

            const cores = ['#3b82f6', '#ec4899', '#f59e0b', '#22c55e', '#8b5cf6'];

            charts.racaChart = new Chart(document.getElementById('racaChart'), {
                type: 'doughnut',
                data: {
                    labels: Object.keys(racaCounts),
                    datasets: [{
                        data: Object.values(racaCounts),
                        backgroundColor: cores
                    }]
                },
                options: {
                    plugins: {
                        title: {
                            display: true,
                            text: 'Por Ra√ßa',
                            font: { size: 16 }
                        }
                    }
                }
            });

            charts.localChart = new Chart(document.getElementById('localChart'), {
                type: 'bar',
                data: {
                    labels: Object.keys(localCounts),
                    datasets: [{
                        data: Object.values(localCounts),
                        backgroundColor: cores,
                        borderRadius: 8
                    }]
                },
                options: {
                    plugins: {
                        title: {
                            display: true,
                            text: 'Por Local',
                            font: { size: 16 }
                        },
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        function gerarRelatorioCompleto() {
            if (animais.length === 0) return alert('‚ö†Ô∏è Sem dados!');
            document.getElementById('tituloRelatorio').innerText = 'üìã Relat√≥rio Completo';
            document.getElementById('previewRelatorio').style.display = 'block';
            
            const ordenados = [...animais].sort((a, b) => {
                const numA = parseInt(a.numero) || 0;
                const numB = parseInt(b.numero) || 0;
                return numA - numB;
            });
            
            let html = '<table style="width:100%; background:white; border-radius:0.7rem;"><thead><tr style="background:#f1f5f9;"><th style="padding:1rem;">N¬∫</th><th style="padding:1rem;">Nome</th><th style="padding:1rem;">Sexo</th><th style="padding:1rem;">Ra√ßa</th><th style="padding:1rem;">Local</th></tr></thead><tbody>';
            ordenados.forEach(a => {
                html += `<tr><td style="padding:1rem;"><strong>${a.numero}</strong></td><td style="padding:1rem;">${a.nome || '-'}</td><td style="padding:1rem;">${a.sexo === 'F' ? '‚ôÄ' : '‚ôÇ'}</td><td style="padding:1rem;">${a.raca}</td><td style="padding:1rem;">${a.local}</td></tr>`;
            });
            html += '</tbody></table>';
            document.getElementById('conteudoRelatorio').innerHTML = html;
        }

        function gerarRelatorioPorRaca() {
            if (animais.length === 0) return alert('‚ö†Ô∏è Sem dados!');
            document.getElementById('tituloRelatorio').innerText = 'üêÑ Por Ra√ßa';
            document.getElementById('previewRelatorio').style.display = 'block';
            const porRaca = {};
            animais.forEach(a => {
                if (!porRaca[a.raca]) porRaca[a.raca] = [];
                porRaca[a.raca].push(a);
            });
            let html = '';
            Object.keys(porRaca).forEach(raca => {
                const ordenados = porRaca[raca].sort((a, b) => {
                    const numA = parseInt(a.numero) || 0;
                    const numB = parseInt(b.numero) || 0;
                    return numA - numB;
                });
                html += `<div style="background:white; padding:1.5rem; border-radius:0.7rem; margin-bottom:1rem;"><h3>${raca} (${ordenados.length})</h3>`;
                ordenados.forEach(a => {
                    html += `<div style="padding:0.5rem; background:#f8fafc; margin:0.3rem 0; border-radius:0.5rem;"><strong>${a.numero}</strong> - ${a.nome || '-'} (${a.sexo === 'F' ? '‚ôÄ' : '‚ôÇ'})</div>`;
                });
                html += '</div>';
            });
            document.getElementById('conteudoRelatorio').innerHTML = html;
        }

        function gerarRelatorioFemeas() {
            const femeas = animais.filter(a => a.sexo === 'F').sort((a, b) => {
                const numA = parseInt(a.numero) || 0;
                const numB = parseInt(b.numero) || 0;
                return numA - numB;
            });
            if (femeas.length === 0) return alert('‚ö†Ô∏è Sem f√™meas!');
            document.getElementById('tituloRelatorio').innerText = '‚ôÄ F√™meas';
            document.getElementById('previewRelatorio').style.display = 'block';
            let html = '<div style="background:white; padding:1.5rem; border-radius:0.7rem;">';
            femeas.forEach(a => {
                html += `<div style="padding:1rem; background:#fef3f2; margin:0.5rem 0; border-radius:0.5rem; border-left:4px solid #ec4899;"><strong>${a.numero} - ${a.nome || '-'}</strong><br><span style="color:#64748b;">${a.raca} | ${a.local}</span></div>`;
            });
            html += '</div>';
            document.getElementById('conteudoRelatorio').innerHTML = html;
        }

        function gerarRelatorioPorProprietario() {
            if (animais.length === 0) return alert('‚ö†Ô∏è Sem dados!');
            document.getElementById('tituloRelatorio').innerText = 'üë• Por Propriet√°rio';
            document.getElementById('previewRelatorio').style.display = 'block';
            const porProprietario = {};
            animais.forEach(a => {
                if (!porProprietario[a.proprietario]) porProprietario[a.proprietario] = [];
                porProprietario[a.proprietario].push(a);
            });
            let html = '';
            Object.keys(porProprietario).forEach(prop => {
                const lista = porProprietario[prop].sort((a, b) => {
                    const numA = parseInt(a.numero) || 0;
                    const numB = parseInt(b.numero) || 0;
                    return numA - numB;
                });
                const femeas = lista.filter(a => a.sexo === 'F').length;
                const machos = lista.filter(a => a.sexo === 'M').length;
                html += `<div style="background:white; padding:1.5rem; border-radius:0.7rem; margin-bottom:1rem; border-left:4px solid #3b82f6;">
                    <h3 style="margin-bottom:1rem;">${prop} <span style="color:#64748b; font-size:0.9rem;">(${lista.length} animais - ${femeas}‚ôÄ ${machos}‚ôÇ)</span></h3>`;
                lista.forEach(a => {
                    html += `<div style="padding:0.7rem; background:#f8fafc; margin:0.3rem 0; border-radius:0.5rem; display:flex; justify-content:space-between;">
                        <span><strong>${a.numero}</strong> - ${a.nome || '-'} ${a.sexo === 'F' ? '‚ôÄ' : '‚ôÇ'}</span>
                        <span style="color:#64748b;">${a.raca} | ${a.local}</span>
                    </div>`;
                });
                html += '</div>';
            });
            document.getElementById('conteudoRelatorio').innerHTML = html;
        }

        function gerarRelatorioAmamentando() {
            const amamentando = animais.filter(a => a.amamentando === true).sort((a, b) => {
                const numA = parseInt(a.numero) || 0;
                const numB = parseInt(b.numero) || 0;
                return numA - numB;
            });
            if (amamentando.length === 0) return alert('‚ö†Ô∏è Nenhuma f√™mea amamentando!');
            document.getElementById('tituloRelatorio').innerText = 'üçº F√™meas Amamentando';
            document.getElementById('previewRelatorio').style.display = 'block';
            let html = `<div style="background:white; padding:1.5rem; border-radius:0.7rem;">
                <div style="background:#fce7f3; padding:1rem; border-radius:0.5rem; margin-bottom:1rem; text-align:center;">
                    <strong style="font-size:1.5rem; color:#be185d;">${amamentando.length}</strong>
                    <div style="color:#64748b;">f√™meas em lacta√ß√£o</div>
                </div>`;
            amamentando.forEach(a => {
                const idade = calcularIdade(a.dataNascimento);
                html += `<div style="padding:1rem; background:#fef3f2; margin:0.5rem 0; border-radius:0.5rem; border-left:4px solid #ec4899;">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <div>
                            <strong style="font-size:1.1rem;">${a.numero} - ${a.nome || '-'}</strong>
                            <div style="color:#64748b; font-size:0.9rem; margin-top:0.3rem;">
                                ${a.raca} | ${a.local} | ${a.proprietario}
                            </div>
                        </div>
                        <div style="text-align:right;">
                            <div style="background:#ec4899; color:white; padding:0.3rem 0.8rem; border-radius:1rem; font-size:0.8rem; font-weight:700;">
                                üçº Lactante
                            </div>
                            <div style="color:#64748b; font-size:0.85rem; margin-top:0.3rem;">Idade: ${idade}</div>
                        </div>
                    </div>
                </div>`;
            });
            html += '</div>';
            document.getElementById('conteudoRelatorio').innerHTML = html;
        }

        function gerarRelatorioSemFerro() {
            const semFerro = animais.filter(a => a.semFerro === true).sort((a, b) => {
                const numA = parseInt(a.numero) || 0;
                const numB = parseInt(b.numero) || 0;
                return numA - numB;
            });
            if (semFerro.length === 0) return alert('‚ö†Ô∏è Todos os animais est√£o marcados!');
            document.getElementById('tituloRelatorio').innerText = 'üîì Animais Sem Ferro';
            document.getElementById('previewRelatorio').style.display = 'block';
            let html = `<div style="background:white; padding:1.5rem; border-radius:0.7rem;">
                <div style="background:#fed7aa; padding:1rem; border-radius:0.5rem; margin-bottom:1rem; text-align:center;">
                    <strong style="font-size:1.5rem; color:#c2410c;">${semFerro.length}</strong>
                    <div style="color:#64748b;">animais sem marca√ß√£o</div>
                </div>`;
            semFerro.forEach(a => {
                const idade = calcularIdade(a.dataNascimento);
                const sexoBadge = a.sexo === 'F' ? '<span style="background:#fce7f3; color:#be185d; padding:0.3rem 0.6rem; border-radius:0.5rem; font-size:0.8rem; font-weight:700;">‚ôÄ</span>' : '<span style="background:#dbeafe; color:#1e40af; padding:0.3rem 0.6rem; border-radius:0.5rem; font-size:0.8rem; font-weight:700;">‚ôÇ</span>';
                html += `<div style="padding:1rem; background:#fef3f2; margin:0.5rem 0; border-radius:0.5rem; border-left:4px solid #f97316;">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <div>
                            <strong style="font-size:1.1rem;">${a.numero} - ${a.nome || '-'}</strong> ${sexoBadge}
                            <div style="color:#64748b; font-size:0.9rem; margin-top:0.3rem;">
                                ${a.raca} | ${a.local} | ${a.proprietario}
                            </div>
                        </div>
                        <div style="text-align:right;">
                            <div style="background:#f97316; color:white; padding:0.3rem 0.8rem; border-radius:1rem; font-size:0.8rem; font-weight:700;">
                                üîì Sem Ferro
                            </div>
                            <div style="color:#64748b; font-size:0.85rem; margin-top:0.3rem;">Idade: ${idade}</div>
                        </div>
                    </div>
                </div>`;
            });
            html += '</div>';
            document.getElementById('conteudoRelatorio').innerHTML = html;
        }

        function fecharRelatorio() {
            document.getElementById('previewRelatorio').style.display = 'none';
        }

        function mostrarGenealogia() {
            const id = document.getElementById('animalGenealogia').value;
            const a = animais.find(x => x.id === id);
            if (!a) {
                document.getElementById('arvoreGenealogia').innerHTML = '<div style="text-align:center; color:#94a3b8; padding:3rem;">Selecione um animal</div>';
                return;
            }
            document.getElementById('arvoreGenealogia').innerHTML = `
                <div style="text-align:center;">
                    <div style="background:linear-gradient(135deg, #3b82f6, #2563eb); color:white; padding:2rem; border-radius:1rem; display:inline-block; min-width:250px; margin-bottom:2rem;">
                        <div style="font-size:2rem; font-weight:800;">${a.numero}</div>
                        <div style="font-size:1.2rem;">${a.nome || 'Sem nome'}</div>
                        <div style="margin-top:0.5rem;">${a.sexo === 'F' ? '‚ôÄ' : '‚ôÇ'} ${a.raca}</div>
                    </div>
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:2rem; max-width:600px; margin:0 auto;">
                        <div style="padding:1.5rem; background:#dbeafe; border-radius:1rem; border:3px solid #3b82f6;">
                            <div style="font-size:0.9rem; color:#1e40af; font-weight:700; margin-bottom:0.5rem;">üêÇ PAI</div>
                            <div style="font-size:1.2rem; font-weight:700;">${a.pai || 'N√£o registrado'}</div>
                        </div>
                        <div style="padding:1.5rem; background:#fce7f3; border-radius:1rem; border:3px solid #ec4899;">
                            <div style="font-size:0.9rem; color:#be185d; font-weight:700; margin-bottom:0.5rem;">üêÑ M√ÉE</div>
                            <div style="font-size:1.2rem; font-weight:700;">${a.mae || 'N√£o registrada'}</div>
                        </div>
                    </div>
                </div>
            `;
        }

        function exportarExcel() {
            if (animais.length === 0) return alert('‚ö†Ô∏è Sem dados!');
            const ordenados = [...animais].sort((a, b) => {
                const numA = parseInt(a.numero) || 0;
                const numB = parseInt(b.numero) || 0;
                return numA - numB;
            });
            const ws = XLSX.utils.json_to_sheet(ordenados);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Rebanho");
            XLSX.writeFile(wb, "Rebanho_" + Date.now() + ".xlsx");
            alert("‚úÖ Excel exportado!");
        }
    </script>
</body>
</html>
